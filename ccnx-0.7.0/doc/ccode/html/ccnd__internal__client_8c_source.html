<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Content-Centric Networking in C: ccnd/ccnd_internal_client.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_2da33aae54c0a0cc386dbc6d79ad0e3b.html">ccnd</a>
  </div>
</div>
<div class="contents">
<h1>ccnd_internal_client.c</h1><a href="ccnd__internal__client_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**</span>
<a name="l00002"></a>00002 <span class="comment"> * @file ccnd_internal_client.c</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Internal client of ccnd, handles requests for</span>
<a name="l00005"></a>00005 <span class="comment"> * inspecting and controlling operation of the ccnd;</span>
<a name="l00006"></a>00006 <span class="comment"> * requests and responses themselves use ccn protocols.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * Part of ccnd - the CCNx Daemon.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * Copyright (C) 2009-2012 Palo Alto Research Center, Inc.</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * This work is free software; you can redistribute it and/or modify it under</span>
<a name="l00013"></a>00013 <span class="comment"> * the terms of the GNU General Public License version 2 as published by the</span>
<a name="l00014"></a>00014 <span class="comment"> * Free Software Foundation.</span>
<a name="l00015"></a>00015 <span class="comment"> * This work is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<a name="l00016"></a>00016 <span class="comment"> * WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<a name="l00017"></a>00017 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment"> * for more details. You should have received a copy of the GNU General Public</span>
<a name="l00019"></a>00019 <span class="comment"> * License along with this program; if not, write to the</span>
<a name="l00020"></a>00020 <span class="comment"> * Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,</span>
<a name="l00021"></a>00021 <span class="comment"> * Boston, MA 02110-1301, USA.</span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;sys/errno.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="ccn_8h.html" title="This is the low-level interface for CCNx clients.">ccn/ccn.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="charbuf_8h.html" title="Expandable character buffer for counted sequences of arbitrary octets.">ccn/charbuf.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="ccn__private_8h.html" title="Additional operations that are irrevalent for most clients.">ccn/ccn_private.h</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="keystore_8h.html" title="KEYSTORE interface.">ccn/keystore.h</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="schedule_8h.html" title="Event scheduling.">ccn/schedule.h</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="sockaddrutil_8h.html" title="sockaddr utilities">ccn/sockaddrutil.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="uri_8h.html" title="ccn-scheme uri conversions.">ccn/uri.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="ccnd__private_8h.html" title="Private definitions for ccnd - the CCNx daemon.">ccnd_private.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#if 0</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#define GOT_HERE ccnd_msg(ccnd, &quot;at ccnd_internal_client.c:%d&quot;, __LINE__);</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00045"></a><a class="code" href="ccnd__internal__client_8c.html#ab62caea8a38a80d3265ace200761a97c">00045</a> <span class="preprocessor"></span><span class="preprocessor">#define GOT_HERE</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00047"></a><a class="code" href="ccnd__internal__client_8c.html#af19907a1c8ea7104bf766924bf233b9c">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define CCND_NOTICE_NAME &quot;notice.txt&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>
<a name="l00049"></a>00049 <span class="preprocessor">#ifndef CCND_TEST_100137</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#define CCND_TEST_100137 0</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a>00053 <span class="preprocessor">#ifndef CCND_PING</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="comment">/* The ping responder is deprecated, but enable it by default for now */</span>
<a name="l00055"></a><a class="code" href="ccnd__internal__client_8c.html#a2433d4d6ec5dd0eb213eb42bb324835e">00055</a> <span class="preprocessor">#define CCND_PING 1</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00058"></a>00058 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="ccnd__internal__client_8c.html#af9d21aae783bf35e49a2ae0a2c146b6b">ccnd_start_notice</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd);
<a name="l00059"></a>00059 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="ccnd__internal__client_8c.html#a630c2ae086977fdf3781944b6d4c453b" title="Schedule recovery from a broken adjacency negotiation.">adjacency_timed_reset</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keywordtype">unsigned</span> faceid);
<a name="l00060"></a>00060 <span class="comment"></span>
<a name="l00061"></a>00061 <span class="comment">/**</span>
<a name="l00062"></a>00062 <span class="comment"> * Creates a key object using the service discovery name profile.</span>
<a name="l00063"></a>00063 <span class="comment"> */</span>
<a name="l00064"></a>00064 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *
<a name="l00065"></a><a class="code" href="ccnd__internal__client_8c.html#a2e974a8c43c86e16849682b97ff71a96">00065</a> <a class="code" href="ccnd__internal__client_8c.html#a2e974a8c43c86e16849682b97ff71a96" title="Creates a key object using the service discovery name profile.">ccnd_init_service_ccnb</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keyword">const</span> <span class="keywordtype">char</span> *baseuri, <span class="keywordtype">int</span> <a class="code" href="ccnc_8c.html#a332b90542523ea1c7f6bd20194fa87d3">freshness</a>)
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067     <span class="keyword">struct </span><a class="code" href="structccn__signing__params.html" title="Parameters for creating signed content objects.">ccn_signing_params</a> sp = <a class="code" href="ccn_8h.html#a4ff046ac820ac0f2ef6acb912a03b328">CCN_SIGNING_PARAMS_INIT</a>;
<a name="l00068"></a>00068     <span class="keyword">struct </span>ccn *h = ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>;
<a name="l00069"></a>00069     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00070"></a>00070     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *pubid = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00071"></a>00071     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *pubkey = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00072"></a>00072     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *keyid = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00073"></a>00073     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cob = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00074"></a>00074     <span class="keywordtype">int</span> res;
<a name="l00075"></a>00075     
<a name="l00076"></a>00076     res = <a class="code" href="ccn_8h.html#ae7ae6fdd5d2582c9fd343c7ba8cd9fbc" title="Place the public key associated with the params into result buffer, and its digest...">ccn_get_public_key</a>(h, NULL, pubid, pubkey);
<a name="l00077"></a>00077     <span class="keywordflow">if</span> (res &lt; 0) abort();
<a name="l00078"></a>00078     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, baseuri);
<a name="l00079"></a>00079     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(keyid, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399a9626cdc2d5d10ce37fb26d9084aaec32" title="commands, etc.">CCN_MARKER_CONTROL</a>, 1);
<a name="l00080"></a>00080     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(keyid, <span class="stringliteral">&quot;.M.K&quot;</span>);
<a name="l00081"></a>00081     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(keyid, 0, 1);
<a name="l00082"></a>00082     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(keyid, pubid);
<a name="l00083"></a>00083     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, keyid-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, keyid-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00084"></a>00084     <a class="code" href="ccn_8h.html#af222a5e0ff25d4f2ff60eed72b3defb2" title="Extend a Name with a new version stamp.">ccn_create_version</a>(h, name, 0, ccnd-&gt;<a class="code" href="structccnd__handle.html#a6dd55108c07745e734cf4cb903a54780" title="ccnd start time, in seconds">starttime</a>, ccnd-&gt;<a class="code" href="structccnd__handle.html#ab1d32a2b2991a0c0c22da2a851cb0e1e" title="ccnd start time fractional part">starttime_usec</a> * 1000);
<a name="l00085"></a>00085     sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00086"></a>00086     <a class="code" href="ccn_8h.html#a2fded0bbb7253c024924baa53beda660" title="Append a ccnb start marker.">ccn_charbuf_append_tt</a>(sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a0287a91fcf8cf8a6ffcd37f03554dc0e">CCN_DTAG_SignedInfo</a>, <a class="code" href="coding_8h.html#a750e116f861c8e3f015cde245bbc0570aea37aecfff1efe438c628cfa8f18c449" title="starts composite - numval is tagdict index (enum ccn_dtag)">CCN_DTAG</a>);
<a name="l00087"></a>00087     <a class="code" href="ccn_8h.html#a2fded0bbb7253c024924baa53beda660" title="Append a ccnb start marker.">ccn_charbuf_append_tt</a>(sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad80ae44b51637e22cc44f3fbdda3499b">CCN_DTAG_KeyLocator</a>, <a class="code" href="coding_8h.html#a750e116f861c8e3f015cde245bbc0570aea37aecfff1efe438c628cfa8f18c449" title="starts composite - numval is tagdict index (enum ccn_dtag)">CCN_DTAG</a>);
<a name="l00088"></a>00088     <a class="code" href="ccn_8h.html#a2fded0bbb7253c024924baa53beda660" title="Append a ccnb start marker.">ccn_charbuf_append_tt</a>(sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a7d74a076884500ed92be7f22355e29f8">CCN_DTAG_KeyName</a>, <a class="code" href="coding_8h.html#a750e116f861c8e3f015cde245bbc0570aea37aecfff1efe438c628cfa8f18c449" title="starts composite - numval is tagdict index (enum ccn_dtag)">CCN_DTAG</a>);
<a name="l00089"></a>00089     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>, name);
<a name="l00090"></a>00090     <a class="code" href="ccn_8h.html#ac8fba19d429bb106de10a008142882aa" title="Append a CCN_CLOSE.">ccn_charbuf_append_closer</a>(sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>);
<a name="l00091"></a>00091     <a class="code" href="ccn_8h.html#ac8fba19d429bb106de10a008142882aa" title="Append a CCN_CLOSE.">ccn_charbuf_append_closer</a>(sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>);
<a name="l00092"></a>00092     <a class="code" href="ccn_8h.html#ac8fba19d429bb106de10a008142882aa" title="Append a CCN_CLOSE.">ccn_charbuf_append_closer</a>(sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>);
<a name="l00093"></a>00093     sp.<a class="code" href="structccn__signing__params.html#a2b9c1f834abea9bd43f1d901e852802e">sp_flags</a> |= <a class="code" href="ccn_8h.html#a67706be4cfcbc355e6f429ed0ec6b2e7">CCN_SP_TEMPL_KEY_LOCATOR</a>;
<a name="l00094"></a>00094     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;%00&quot;</span>);
<a name="l00095"></a>00095     sp.<a class="code" href="structccn__signing__params.html#a2b9c1f834abea9bd43f1d901e852802e">sp_flags</a> |= <a class="code" href="ccn_8h.html#abff51f3f313d457fbcc13006343fdd28">CCN_SP_FINAL_BLOCK</a>;
<a name="l00096"></a>00096     sp.<a class="code" href="structccn__signing__params.html#a4816531af13fcf3981ea44bf2d4c9b2f">type</a> = <a class="code" href="ccn_8h.html#a5ac452b850189ae724c4ff89ae81c702ac721241f29c64d4acd212497a30b362c">CCN_CONTENT_KEY</a>;
<a name="l00097"></a>00097     sp.<a class="code" href="structccn__signing__params.html#a768c61b9b4e01e677bcd89f6be350367">freshness</a> = freshness;
<a name="l00098"></a>00098     res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(h, cob, name, &amp;sp, pubkey-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, pubkey-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00099"></a>00099     <span class="keywordflow">if</span> (res != 0) abort();
<a name="l00100"></a>00100     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00101"></a>00101     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;pubid);
<a name="l00102"></a>00102     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;pubkey);
<a name="l00103"></a>00103     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;keyid);
<a name="l00104"></a>00104     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>);
<a name="l00105"></a>00105     <span class="keywordflow">return</span>(cob);
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="comment">/* These are used in face-&gt;adjstate to track our state */</span>
<a name="l00109"></a><a class="code" href="ccnd__internal__client_8c.html#a34846ec88e326ca9e5c469b0fd806bc7">00109</a> <span class="preprocessor">#define ADJ_SOL_SENT (1U &lt;&lt; 0)</span>
<a name="l00110"></a><a class="code" href="ccnd__internal__client_8c.html#ae7439449fa73e7b63a43ac38eac5095c">00110</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_SOL_RECV (1U &lt;&lt; 1)</span>
<a name="l00111"></a><a class="code" href="ccnd__internal__client_8c.html#a85bb13ed7768c40b10ef5b03a1fc7d1d">00111</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_OFR_SENT (1U &lt;&lt; 2)</span>
<a name="l00112"></a><a class="code" href="ccnd__internal__client_8c.html#abd0487488ae47a4ae7497ca20f0c9aba">00112</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_OFR_RECV (1U &lt;&lt; 3)</span>
<a name="l00113"></a><a class="code" href="ccnd__internal__client_8c.html#adc41a64e5dd78c6c23bcad43c624b199">00113</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_CRQ_SENT (1U &lt;&lt; 4)</span>
<a name="l00114"></a><a class="code" href="ccnd__internal__client_8c.html#a85aaca3a09dc18b82ac76353f5ba5e9c">00114</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_CRQ_RECV (1U &lt;&lt; 5)</span>
<a name="l00115"></a><a class="code" href="ccnd__internal__client_8c.html#a14825114770d32358ba3728d4e351bbe">00115</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_DAT_SENT (1U &lt;&lt; 6)</span>
<a name="l00116"></a><a class="code" href="ccnd__internal__client_8c.html#afc9a19612aee413b9cfc53d9af752bcc">00116</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_DAT_RECV (1U &lt;&lt; 7)</span>
<a name="l00117"></a><a class="code" href="ccnd__internal__client_8c.html#aa85b9730b33d5be316e5254999d64e5b">00117</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_TIMEDWAIT (1U &lt;&lt; 8)</span>
<a name="l00118"></a><a class="code" href="ccnd__internal__client_8c.html#ac72f442caacce475c82e41c82e71e64b">00118</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_PINGING  (1U &lt;&lt; 9)</span>
<a name="l00119"></a><a class="code" href="ccnd__internal__client_8c.html#aa3e6a44172ac5b43333b7613210c4ccb">00119</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_RETRYING (1U &lt;&lt; 10)</span>
<a name="l00120"></a><a class="code" href="ccnd__internal__client_8c.html#ac982c06643f5c679d785fc020cf25e29">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_ACTIVE   (1U &lt;&lt; 11)</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00122"></a>00122 <span class="comment">/**</span>
<a name="l00123"></a>00123 <span class="comment"> * Update face-&gt;adjstate by setting / clearing the indicated bits.</span>
<a name="l00124"></a>00124 <span class="comment"> *</span>
<a name="l00125"></a>00125 <span class="comment"> * If a bit is in both masks, it is set.</span>
<a name="l00126"></a>00126 <span class="comment"> * @returns the old values, or -1 for an error.</span>
<a name="l00127"></a>00127 <span class="comment"> */</span>
<a name="l00128"></a>00128 <span class="keywordtype">int</span>
<a name="l00129"></a><a class="code" href="ccnd__internal__client_8c.html#a5a3d8bfd573c2f6843a32d21e245f922">00129</a> <a class="code" href="ccnd__internal__client_8c.html#a5a3d8bfd573c2f6843a32d21e245f922" title="Update face-&amp;gt;adjstate by setting / clearing the indicated bits.">adjstate_change_db</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keyword">struct</span> <a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a>,
<a name="l00130"></a>00130                 <span class="keywordtype">int</span> <span class="keyword">set</span>, <span class="keywordtype">int</span> clear, <span class="keywordtype">int</span> line)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132     <span class="keywordtype">int</span> <span class="keyword">new</span>;
<a name="l00133"></a>00133     <span class="keywordtype">int</span> old;
<a name="l00134"></a>00134     
<a name="l00135"></a>00135     <span class="keywordflow">if</span> (face == NULL)
<a name="l00136"></a>00136         <span class="keywordflow">return</span>(-1);
<a name="l00137"></a>00137     old = face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a>;
<a name="l00138"></a>00138     <span class="keyword">new</span> = (old &amp; ~clear) | <span class="keyword">set</span>;
<a name="l00139"></a>00139     <span class="keywordflow">if</span> (<span class="keyword">new</span> != old) {
<a name="l00140"></a>00140         face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> = <span class="keyword">new</span>;
<a name="l00141"></a>00141         <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#af1f782a44b7c5da14c5608974cc7677c" title="For controlling debug output.">debug</a> &amp; (2 | 4)) {
<a name="l00142"></a>00142             <span class="comment">/* display the bits in face-&gt;adjstate */</span>
<a name="l00143"></a>00143             <span class="keywordtype">char</span> f[] = <span class="stringliteral">&quot;sSoOcCdDTPRA\0&quot;</span>;
<a name="l00144"></a>00144             <span class="keywordtype">int</span> i;
<a name="l00145"></a>00145             <span class="keywordflow">for</span> (i = 0; f[i] != 0; i++)
<a name="l00146"></a>00146                 <span class="keywordflow">if</span> (((<span class="keyword">new</span> &gt;&gt; i) &amp; 1) == 0)
<a name="l00147"></a>00147                     f[i] = <span class="charliteral">&#39;.&#39;</span>;
<a name="l00148"></a>00148             <a class="code" href="ccnd__msg_8c.html#ab366c8b24b40d405717b70124e6049be" title="Produce ccnd debug output.">ccnd_msg</a>(ccnd, <span class="stringliteral">&quot;ic.%d adjstate %u %s %#x&quot;</span>, line,
<a name="l00149"></a>00149                      face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>, f, face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a>);
<a name="l00150"></a>00150         }
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152     <span class="keywordflow">return</span>(old);
<a name="l00153"></a>00153 }
<a name="l00154"></a><a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">00154</a> <span class="preprocessor">#define adjstate_change(h, f, s, c) adjstate_change_db(h, f, s, c, __LINE__)</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span><span class="comment">/**</span>
<a name="l00156"></a>00156 <span class="comment"> * Append the URI representation of the adjacency prefix for face to the</span>
<a name="l00157"></a>00157 <span class="comment"> * charbuf cb.</span>
<a name="l00158"></a>00158 <span class="comment"> * @returns 0 for success, -1 for error.</span>
<a name="l00159"></a>00159 <span class="comment"> */</span>
<a name="l00160"></a>00160 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00161"></a><a class="code" href="ccnd__internal__client_8c.html#a89052e5e0cdb2dea9b09601f4e758189">00161</a> <a class="code" href="ccnd__internal__client_8c.html#a89052e5e0cdb2dea9b09601f4e758189" title="Append the URI representation of the adjacency prefix for face to the charbuf cb...">append_adjacency_uri</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd,
<a name="l00162"></a>00162                      <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cb, <span class="keyword">struct</span> <a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a>)
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l00165"></a>00165     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *comp = NULL;
<a name="l00166"></a>00166     <span class="keywordtype">int</span> res;
<a name="l00167"></a>00167     
<a name="l00168"></a>00168     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> == NULL)
<a name="l00169"></a>00169         <span class="keywordflow">return</span>(-1);
<a name="l00170"></a>00170     comp = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00171"></a>00171     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00172"></a>00172     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;ccnx:/%C1.M.FACE&quot;</span>);
<a name="l00173"></a>00173     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(comp, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399a9626cdc2d5d10ce37fb26d9084aaec32" title="commands, etc.">CCN_MARKER_CONTROL</a>, 1);
<a name="l00174"></a>00174     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(comp, <span class="stringliteral">&quot;.M.G&quot;</span>);
<a name="l00175"></a>00175     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(comp, 0, 1);
<a name="l00176"></a>00176     <a class="code" href="ccnd_8c.html#a8dcea631c5a6900917f4282991ee3044" title="Append the guid associated with a face to a charbuf.">ccnd_append_face_guid</a>(ccnd, comp, face);
<a name="l00177"></a>00177     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, comp-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, comp-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00178"></a>00178     res = <a class="code" href="uri_8h.html#a46512a74f8d78b3e01fbc115f652ae8d" title="This appends to c a URI representation of the ccnb-encoded Name element passed in...">ccn_uri_append</a>(cb, name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1);
<a name="l00179"></a>00179     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;comp);
<a name="l00180"></a>00180     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00181"></a>00181     <span class="keywordflow">return</span>(res &lt; 0 ? -1 : 0);
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="ccnd__internal__client_8c.html#aa248a79fb0cb280ce2a37736810517e5">00184</a> <span class="preprocessor">#define ADJ_REFRESH_SEC 120</span>
<a name="l00185"></a><a class="code" href="ccnd__internal__client_8c.html#a84d26a7e9fee81baecc41d4f4d2b0219">00185</a> <span class="preprocessor"></span><span class="preprocessor">#define ADJ_MICROS (ADJ_REFRESH_SEC * 1000000)</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span><span class="comment">/**</span>
<a name="l00187"></a>00187 <span class="comment"> * Scheduled event to refresh adjacency</span>
<a name="l00188"></a>00188 <span class="comment"> */</span>
<a name="l00189"></a>00189 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00190"></a><a class="code" href="ccnd__internal__client_8c.html#a3597d3354ca9f9417f1e36ff273849be">00190</a> <a class="code" href="ccnd__internal__client_8c.html#a3597d3354ca9f9417f1e36ff273849be" title="Scheduled event to refresh adjacency.">adjacency_do_refresh</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00191"></a>00191                      <span class="keywordtype">void</span> *clienth,
<a name="l00192"></a>00192                      <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00193"></a>00193                      <span class="keywordtype">int</span> flags)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195     <span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd = clienth;
<a name="l00196"></a>00196     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = NULL;
<a name="l00197"></a>00197     <span class="keywordtype">unsigned</span> both;
<a name="l00198"></a>00198     
<a name="l00199"></a>00199     face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, ev-&gt;<a class="code" href="structccn__scheduled__event.html#a22f5ee0bc7a266aa2d35ad482cb8c4c3">evint</a>);
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (face == NULL)
<a name="l00201"></a>00201         <span class="keywordflow">return</span>(0);
<a name="l00202"></a>00202     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) != 0) {
<a name="l00203"></a>00203         <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, 0, <a class="code" href="ccnd__internal__client_8c.html#ac982c06643f5c679d785fc020cf25e29">ADJ_ACTIVE</a>);
<a name="l00204"></a>00204         <span class="keywordflow">return</span>(0);
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206     both = <a class="code" href="ccnd__internal__client_8c.html#afc9a19612aee413b9cfc53d9af752bcc">ADJ_DAT_RECV</a> | <a class="code" href="ccnd__internal__client_8c.html#a14825114770d32358ba3728d4e351bbe">ADJ_DAT_SENT</a>;
<a name="l00207"></a>00207     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; both) == both) {
<a name="l00208"></a>00208         <a class="code" href="ccnd__internal__client_8c.html#aadecfbdfe316a850a93580c4499ebc9c" title="Express an interest to pull adjacency information from the other side.">ccnd_adjacency_offer_or_commit_req</a>(ccnd, face);
<a name="l00209"></a>00209         <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; <a class="code" href="ccnd__internal__client_8c.html#ac72f442caacce475c82e41c82e71e64b">ADJ_PINGING</a>) != 0)
<a name="l00210"></a>00210             <span class="keywordflow">return</span>((<a class="code" href="ccnd__internal__client_8c.html#a84d26a7e9fee81baecc41d4f4d2b0219">ADJ_MICROS</a> + nrand48(ccnd-&gt;<a class="code" href="structccnd__handle.html#a08e836efa870eb42c0fdba1e08886862" title="for PRNG">seed</a>) % <a class="code" href="ccnd__internal__client_8c.html#a84d26a7e9fee81baecc41d4f4d2b0219">ADJ_MICROS</a>) / 2);
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212     <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, 0, <a class="code" href="ccnd__internal__client_8c.html#ac982c06643f5c679d785fc020cf25e29">ADJ_ACTIVE</a>);
<a name="l00213"></a>00213     <span class="keywordflow">return</span>(0);
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 <span class="comment"></span>
<a name="l00216"></a>00216 <span class="comment">/**</span>
<a name="l00217"></a>00217 <span class="comment"> * Register the adjacency prefix with the given forwarding flags.</span>
<a name="l00218"></a>00218 <span class="comment"> */</span>
<a name="l00219"></a>00219 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00220"></a><a class="code" href="ccnd__internal__client_8c.html#ac13ee3828f4674ea216d0d84574bc7dc">00220</a> <a class="code" href="ccnd__internal__client_8c.html#ac13ee3828f4674ea216d0d84574bc7dc" title="Register the adjacency prefix with the given forwarding flags.">ccnd_register_adjacency</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keyword">struct</span> <a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a>,
<a name="l00221"></a>00221                         <span class="keywordtype">unsigned</span> forwarding_flags)
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *uri = NULL;
<a name="l00224"></a>00224     <span class="keywordtype">unsigned</span> both;
<a name="l00225"></a>00225     <span class="keywordtype">int</span> res;
<a name="l00226"></a>00226     <span class="keywordtype">int</span> adj = 0;
<a name="l00227"></a>00227     <span class="keywordtype">int</span> lifetime = 0;
<a name="l00228"></a>00228     
<a name="l00229"></a>00229     <span class="keywordflow">if</span> ((forwarding_flags &amp; <a class="code" href="reg__mgmt_8h.html#ae0ad3c46c8762dc3117420b77af96249" title="Refer to doc/technical/Registration.txt for the meaning of these flags.">CCN_FORW_ACTIVE</a>) != 0) {
<a name="l00230"></a>00230         adj = <a class="code" href="ccnd__private_8h.html#a0812bb8fb538d1c4cfa366fac505f9a9">CCN_FACE_ADJ</a>;
<a name="l00231"></a>00231         lifetime = <a class="code" href="ccnd__internal__client_8c.html#aa248a79fb0cb280ce2a37736810517e5">ADJ_REFRESH_SEC</a>; <span class="comment">/* seconds */</span>
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233     both = <a class="code" href="ccnd__internal__client_8c.html#afc9a19612aee413b9cfc53d9af752bcc">ADJ_DAT_RECV</a> | <a class="code" href="ccnd__internal__client_8c.html#a14825114770d32358ba3728d4e351bbe">ADJ_DAT_SENT</a>;
<a name="l00234"></a>00234     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; both) != both)
<a name="l00235"></a>00235         <span class="keywordflow">return</span>;
<a name="l00236"></a>00236     uri = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00237"></a>00237     res = <a class="code" href="ccnd__internal__client_8c.html#a89052e5e0cdb2dea9b09601f4e758189" title="Append the URI representation of the adjacency prefix for face to the charbuf cb...">append_adjacency_uri</a>(ccnd, uri, face);
<a name="l00238"></a>00238     <span class="keywordflow">if</span> (res &gt;= 0)
<a name="l00239"></a>00239         res = <a class="code" href="ccnd_8c.html#a6a4a51f315cdeac27bdee3546f9d88f0" title="Register a prefix, expressed in the form of a URI.">ccnd_reg_uri</a>(ccnd, <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uri), face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>,
<a name="l00240"></a>00240                            forwarding_flags, lifetime);
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l00242"></a>00242         <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> &amp; <a class="code" href="ccnd__private_8h.html#a0812bb8fb538d1c4cfa366fac505f9a9">CCN_FACE_ADJ</a>) != adj) {
<a name="l00243"></a>00243             face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> ^= <a class="code" href="ccnd__private_8h.html#a0812bb8fb538d1c4cfa366fac505f9a9">CCN_FACE_ADJ</a>;
<a name="l00244"></a>00244             <a class="code" href="ccnd__internal__client_8c.html#a9a8312e047d60e5e17dbe0f248ada546" title="Called by ccnd when a face undergoes a substantive status change that should be reported...">ccnd_face_status_change</a>(ccnd, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246         <span class="keywordflow">if</span> (lifetime != 0 &amp;&amp; (face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; <a class="code" href="ccnd__internal__client_8c.html#ac982c06643f5c679d785fc020cf25e29">ADJ_ACTIVE</a>) == 0) {
<a name="l00247"></a>00247             <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a>, lifetime * 1000000,
<a name="l00248"></a>00248                                <a class="code" href="ccnd__internal__client_8c.html#a3597d3354ca9f9417f1e36ff273849be" title="Scheduled event to refresh adjacency.">adjacency_do_refresh</a>, NULL, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00249"></a>00249             <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#ac982c06643f5c679d785fc020cf25e29">ADJ_ACTIVE</a>, 0);
<a name="l00250"></a>00250         }
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;uri);
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 <span class="comment"></span>
<a name="l00255"></a>00255 <span class="comment">/**</span>
<a name="l00256"></a>00256 <span class="comment"> * Scheduled event for getting rid of an old guid cob.</span>
<a name="l00257"></a>00257 <span class="comment"> */</span>
<a name="l00258"></a>00258 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00259"></a><a class="code" href="ccnd__internal__client_8c.html#a3a4077051174e318f5d6def495f81d78">00259</a> <a class="code" href="ccnd__internal__client_8c.html#a3a4077051174e318f5d6def495f81d78" title="Scheduled event for getting rid of an old guid cob.">ccnd_flush_guid_cob</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00260"></a>00260                     <span class="keywordtype">void</span> *clienth,
<a name="l00261"></a>00261                     <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00262"></a>00262                     <span class="keywordtype">int</span> flags)
<a name="l00263"></a>00263 {
<a name="l00264"></a>00264     <span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd = clienth;
<a name="l00265"></a>00265     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = NULL;
<a name="l00266"></a>00266     
<a name="l00267"></a>00267     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) != 0)
<a name="l00268"></a>00268         <span class="keywordflow">return</span>(0);
<a name="l00269"></a>00269     face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, ev-&gt;<a class="code" href="structccn__scheduled__event.html#a22f5ee0bc7a266aa2d35ad482cb8c4c3">evint</a>);
<a name="l00270"></a>00270     <span class="keywordflow">if</span> (face != NULL)
<a name="l00271"></a>00271         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>);
<a name="l00272"></a>00272     <span class="keywordflow">return</span>(0);
<a name="l00273"></a>00273 }
<a name="l00274"></a>00274 <span class="comment"></span>
<a name="l00275"></a>00275 <span class="comment">/**</span>
<a name="l00276"></a>00276 <span class="comment"> * Create the adjacency content object for our endpoint of the face.</span>
<a name="l00277"></a>00277 <span class="comment"> */</span>
<a name="l00278"></a>00278 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00279"></a><a class="code" href="ccnd__internal__client_8c.html#a7208433d97c817cb153e44cf7cd26841">00279</a> <a class="code" href="ccnd__internal__client_8c.html#a7208433d97c817cb153e44cf7cd26841" title="Create the adjacency content object for our endpoint of the face.">ccnd_init_face_guid_cob</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keyword">struct</span> <a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a>)
<a name="l00280"></a>00280 {
<a name="l00281"></a>00281     <span class="keyword">struct </span><a class="code" href="structccn__signing__params.html" title="Parameters for creating signed content objects.">ccn_signing_params</a> sp = <a class="code" href="ccn_8h.html#a4ff046ac820ac0f2ef6acb912a03b328">CCN_SIGNING_PARAMS_INIT</a>;
<a name="l00282"></a>00282     <span class="keyword">struct </span>ccn *h = ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>;
<a name="l00283"></a>00283     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l00284"></a>00284     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *payload = NULL;
<a name="l00285"></a>00285     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *comp = NULL;
<a name="l00286"></a>00286     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cob = NULL;
<a name="l00287"></a>00287     <span class="keywordtype">int</span> res;
<a name="l00288"></a>00288     <span class="keywordtype">int</span> seconds = 60; <span class="comment">/* freshness in the object */</span>
<a name="l00289"></a>00289     <span class="keywordtype">int</span> nfresh = 20; <span class="comment">/* flush it after this many freshness periods */</span>
<a name="l00290"></a>00290     
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> == NULL || face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a> != NULL)
<a name="l00292"></a>00292         <span class="keywordflow">return</span>;
<a name="l00293"></a>00293     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#a85bb13ed7768c40b10ef5b03a1fc7d1d">ADJ_OFR_SENT</a> | <a class="code" href="ccnd__internal__client_8c.html#abd0487488ae47a4ae7497ca20f0c9aba">ADJ_OFR_RECV</a>)) == 0)
<a name="l00294"></a>00294         <span class="keywordflow">return</span>;
<a name="l00295"></a>00295     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00296"></a>00296     payload = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00297"></a>00297     comp = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00298"></a>00298     cob = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00299"></a>00299     
<a name="l00300"></a>00300     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;ccnx:/%C1.M.FACE&quot;</span>);
<a name="l00301"></a>00301     <span class="comment">/* %C1.G.%00&lt;guid&gt; */</span>
<a name="l00302"></a>00302     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(comp);
<a name="l00303"></a>00303     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(comp, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399a9626cdc2d5d10ce37fb26d9084aaec32" title="commands, etc.">CCN_MARKER_CONTROL</a>, 1);
<a name="l00304"></a>00304     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(comp, <span class="stringliteral">&quot;.M.G&quot;</span>);
<a name="l00305"></a>00305     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(comp, 0, 1);
<a name="l00306"></a>00306     <a class="code" href="ccnd_8c.html#a8dcea631c5a6900917f4282991ee3044" title="Append the guid associated with a face to a charbuf.">ccnd_append_face_guid</a>(ccnd, comp, face);
<a name="l00307"></a>00307     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, comp-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, comp-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00308"></a>00308     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;%C1.M.NODE&quot;</span>);
<a name="l00309"></a>00309     <span class="comment">/* %C1.K.%00&lt;ccndid&gt; */</span>
<a name="l00310"></a>00310     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(comp);
<a name="l00311"></a>00311     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(comp, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399a9626cdc2d5d10ce37fb26d9084aaec32" title="commands, etc.">CCN_MARKER_CONTROL</a>, 1);
<a name="l00312"></a>00312     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(comp, <span class="stringliteral">&quot;.M.K&quot;</span>);
<a name="l00313"></a>00313     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(comp, 0, 1);
<a name="l00314"></a>00314     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(comp, ccnd-&gt;<a class="code" href="structccnd__handle.html#a935a4fbf6e79b677d425d49661326e7e" title="sha256 digest of our public key">ccnd_id</a>, <span class="keyword">sizeof</span>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a935a4fbf6e79b677d425d49661326e7e" title="sha256 digest of our public key">ccnd_id</a>));
<a name="l00315"></a>00315     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, comp-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, comp-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00316"></a>00316     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(comp);
<a name="l00317"></a>00317     <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(comp, <span class="stringliteral">&quot;face~%u&quot;</span>, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00318"></a>00318     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, comp-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, comp-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00319"></a>00319     <a class="code" href="ccn_8h.html#af222a5e0ff25d4f2ff60eed72b3defb2" title="Extend a Name with a new version stamp.">ccn_create_version</a>(h, name, <a class="code" href="ccn_8h.html#ac0d9b4a6ddee8ae94d87d8c2340ac907" title="use current time">CCN_V_NOW</a>, 0, 0);
<a name="l00320"></a>00320     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;%00&quot;</span>);
<a name="l00321"></a>00321     sp.<a class="code" href="structccn__signing__params.html#a2b9c1f834abea9bd43f1d901e852802e">sp_flags</a> |= <a class="code" href="ccn_8h.html#abff51f3f313d457fbcc13006343fdd28">CCN_SP_FINAL_BLOCK</a>;
<a name="l00322"></a>00322     sp.<a class="code" href="structccn__signing__params.html#a768c61b9b4e01e677bcd89f6be350367">freshness</a> = seconds;
<a name="l00323"></a>00323     res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(h, cob, name, &amp;sp, payload-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, payload-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00324"></a>00324     <span class="keywordflow">if</span> (res != 0)
<a name="l00325"></a>00325         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;cob);
<a name="l00326"></a>00326     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00327"></a>00327     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;payload);
<a name="l00328"></a>00328     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;comp);
<a name="l00329"></a>00329     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;sp.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>);
<a name="l00330"></a>00330     face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a> = cob;
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (cob != NULL)
<a name="l00332"></a>00332         <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a>, nfresh * seconds * 1000000 - 800000,
<a name="l00333"></a>00333                            <a class="code" href="ccnd__internal__client_8c.html#a3a4077051174e318f5d6def495f81d78" title="Scheduled event for getting rid of an old guid cob.">ccnd_flush_guid_cob</a>, NULL, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 <span class="comment"></span>
<a name="l00336"></a>00336 <span class="comment">/**</span>
<a name="l00337"></a>00337 <span class="comment"> * Isolate the lower and upper bounds for the guid component from Exclude</span>
<a name="l00338"></a>00338 <span class="comment"> *</span>
<a name="l00339"></a>00339 <span class="comment"> * This is used as part of the adjacency protocol.</span>
<a name="l00340"></a>00340 <span class="comment"> */</span>
<a name="l00341"></a>00341 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00342"></a><a class="code" href="ccnd__internal__client_8c.html#a46fc7020caa23d44bb66cf0175cde4ca">00342</a> <a class="code" href="ccnd__internal__client_8c.html#a46fc7020caa23d44bb66cf0175cde4ca" title="Isolate the lower and upper bounds for the guid component from Exclude.">extract_bounds</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ccnb, <span class="keyword">struct</span> <a class="code" href="structccn__parsed__interest.html">ccn_parsed_interest</a> *pi,
<a name="l00343"></a>00343                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **plo, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **phi)
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> decoder;
<a name="l00346"></a>00346     <span class="keyword">struct </span><a class="code" href="structccn__buf__decoder.html">ccn_buf_decoder</a> *d = NULL;
<a name="l00347"></a>00347     <span class="keywordtype">int</span> res = -1;
<a name="l00348"></a>00348     <span class="keywordtype">int</span> x;
<a name="l00349"></a>00349     <span class="keywordtype">int</span> y;
<a name="l00350"></a>00350     <span class="keywordtype">int</span> z;
<a name="l00351"></a>00351     <span class="keywordtype">size_t</span> sz;
<a name="l00352"></a>00352     
<a name="l00353"></a>00353     <span class="comment">/* We are interested only in the Exclude element. */</span>
<a name="l00354"></a>00354     ccnb = ccnb + pi-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a4c40a9e5305b7602b96ababfd02f6775">CCN_PI_B_Exclude</a>];
<a name="l00355"></a>00355     sz = pi-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ad7411aa4c9a0b67d3b48c4abbe1e0f0a">CCN_PI_E_Exclude</a>] - pi-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9a4c40a9e5305b7602b96ababfd02f6775">CCN_PI_B_Exclude</a>];
<a name="l00356"></a>00356     <span class="keywordflow">if</span> (sz != 0) {
<a name="l00357"></a>00357         d = <a class="code" href="ccn_8h.html#a4ba830f8dad511663779d85122db633a">ccn_buf_decoder_start</a>(&amp;decoder, ccnb, sz);
<a name="l00358"></a>00358         <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9dcce1e4306cb7fd0e58d99ef370476e">CCN_DTAG_Exclude</a>)) {
<a name="l00359"></a>00359             <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00360"></a>00360             <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33adb951474c9a5705b47af838bc536ee24">CCN_DTAG_Any</a>)) {
<a name="l00361"></a>00361                 <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00362"></a>00362                 <a class="code" href="ccn_8h.html#a1868a32594c3c2a98e60049a3f3184b8" title="Enter an error state if element closer not found.">ccn_buf_check_close</a>(d);
<a name="l00363"></a>00363             }
<a name="l00364"></a>00364             <span class="keywordflow">else</span> <span class="keywordflow">return</span>(-1);
<a name="l00365"></a>00365             x = d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a1a01207fc832f394a15137371255f197" title="Starting index of most-recent token.">token_index</a>;
<a name="l00366"></a>00366             <a class="code" href="ccn_8h.html#a0125f8cc6f65a009336d50cb62438c55">ccn_parse_required_tagged_BLOB</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad20ad6d29fb3d5cb3631152e0fc1ccc0">CCN_DTAG_Component</a>, 8, 70);
<a name="l00367"></a>00367             y = d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a1a01207fc832f394a15137371255f197" title="Starting index of most-recent token.">token_index</a>;
<a name="l00368"></a>00368             <a class="code" href="ccn_8h.html#a0125f8cc6f65a009336d50cb62438c55">ccn_parse_required_tagged_BLOB</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad20ad6d29fb3d5cb3631152e0fc1ccc0">CCN_DTAG_Component</a>, 8, 70);
<a name="l00369"></a>00369             z = d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a1a01207fc832f394a15137371255f197" title="Starting index of most-recent token.">token_index</a>;
<a name="l00370"></a>00370             <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a127d4f9a3f901ba15bc5335d5a9fa3b0">ccn_buf_match_dtag</a>(d, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33adb951474c9a5705b47af838bc536ee24">CCN_DTAG_Any</a>)) {
<a name="l00371"></a>00371                 <a class="code" href="ccn_8h.html#a1b17cadb92b2339cba24721b0466a0ce">ccn_buf_advance</a>(d);
<a name="l00372"></a>00372                 <a class="code" href="ccn_8h.html#a1868a32594c3c2a98e60049a3f3184b8" title="Enter an error state if element closer not found.">ccn_buf_check_close</a>(d);
<a name="l00373"></a>00373             }
<a name="l00374"></a>00374             <span class="keywordflow">else</span> <span class="keywordflow">return</span>(-1);
<a name="l00375"></a>00375             <a class="code" href="ccn_8h.html#a1868a32594c3c2a98e60049a3f3184b8" title="Enter an error state if element closer not found.">ccn_buf_check_close</a>(d);
<a name="l00376"></a>00376             <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structccn__buf__decoder.html#ad0c36c4f48a2a7995653059161ca4ba9">decoder</a>.<a class="code" href="structccn__skeleton__decoder.html#a59243d42e65373a2946e57137e244389" title="Decoder state.">state</a> &lt; 0)
<a name="l00377"></a>00377                 <span class="keywordflow">return</span> (-1);
<a name="l00378"></a>00378             <span class="keywordflow">if</span> (y - x != z - y)
<a name="l00379"></a>00379                 <span class="keywordflow">return</span>(-1);
<a name="l00380"></a>00380             res = <a class="code" href="ccn_8h.html#af630540ae5874ba0b17f1960482a85a9">ccn_ref_tagged_BLOB</a>(<a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad20ad6d29fb3d5cb3631152e0fc1ccc0">CCN_DTAG_Component</a>, ccnb, x, y, plo, &amp;sz);
<a name="l00381"></a>00381             <span class="keywordflow">if</span> (res &lt; 0) <span class="keywordflow">return</span>(-1);
<a name="l00382"></a>00382             res = <a class="code" href="ccn_8h.html#af630540ae5874ba0b17f1960482a85a9">ccn_ref_tagged_BLOB</a>(<a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad20ad6d29fb3d5cb3631152e0fc1ccc0">CCN_DTAG_Component</a>, ccnb, y, z, phi, &amp;sz);
<a name="l00383"></a>00383             <span class="keywordflow">if</span> (res &lt; 0) <span class="keywordflow">return</span>(-1);
<a name="l00384"></a>00384             <span class="keywordflow">return</span>(sz);
<a name="l00385"></a>00385         }
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387     <span class="keywordflow">return</span>(-1);
<a name="l00388"></a>00388 }
<a name="l00389"></a>00389 <span class="comment"></span>
<a name="l00390"></a>00390 <span class="comment">/**</span>
<a name="l00391"></a>00391 <span class="comment"> * Handle the data that comes back in response to interest sent by</span>
<a name="l00392"></a>00392 <span class="comment"> * send_adjacency_solicit.</span>
<a name="l00393"></a>00393 <span class="comment"> *</span>
<a name="l00394"></a>00394 <span class="comment"> * We don&#39;t actually need to do much here, since the protocol is actually</span>
<a name="l00395"></a>00395 <span class="comment"> * looking for an interest from the other side.</span>
<a name="l00396"></a>00396 <span class="comment"> */</span>
<a name="l00397"></a>00397 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00398"></a><a class="code" href="ccnd__internal__client_8c.html#adf8d85f0c8439422fb6808b39f8bbabb">00398</a> <a class="code" href="ccnd__internal__client_8c.html#adf8d85f0c8439422fb6808b39f8bbabb" title="Handle the data that comes back in response to interest sent by send_adjacency_solicit...">solicit_response</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00399"></a>00399                    <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00400"></a>00400                    <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info)
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = NULL;
<a name="l00403"></a>00403     <span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd = selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l00404"></a>00404     
<a name="l00405"></a>00405     <span class="keywordflow">switch</span> (kind) {
<a name="l00406"></a>00406         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92ad00afdf8a89c718f4c451600b115b5e0" title="handler is about to be deregistered">CCN_UPCALL_FINAL</a>:
<a name="l00407"></a>00407             free(selfp);
<a name="l00408"></a>00408             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00409"></a>00409         <span class="keywordflow">default</span>:
<a name="l00410"></a>00410             face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a>);
<a name="l00411"></a>00411             <span class="keywordflow">if</span> (face == NULL)
<a name="l00412"></a>00412                 <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00413"></a>00413             <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#a34846ec88e326ca9e5c469b0fd806bc7">ADJ_SOL_SENT</a>)) != 0)
<a name="l00414"></a>00414                 <a class="code" href="ccnd__internal__client_8c.html#a630c2ae086977fdf3781944b6d4c453b" title="Schedule recovery from a broken adjacency negotiation.">adjacency_timed_reset</a>(ccnd, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00415"></a>00415             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417 }
<a name="l00418"></a>00418 <span class="comment"></span>
<a name="l00419"></a>00419 <span class="comment">/**</span>
<a name="l00420"></a>00420 <span class="comment"> * Send an adjacency solitiation interest, to elicit an offer from the</span>
<a name="l00421"></a>00421 <span class="comment"> * other side.</span>
<a name="l00422"></a>00422 <span class="comment"> */</span>
<a name="l00423"></a>00423 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00424"></a><a class="code" href="ccnd__internal__client_8c.html#aa5f2a476a8a1c2fca0b6fae2e7eefa0c">00424</a> <a class="code" href="ccnd__internal__client_8c.html#aa5f2a476a8a1c2fca0b6fae2e7eefa0c" title="Send an adjacency solitiation interest, to elicit an offer from the other side.">send_adjacency_solicit</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keyword">struct</span> <a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a>)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name;
<a name="l00427"></a>00427     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *c;
<a name="l00428"></a>00428     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *g;
<a name="l00429"></a>00429     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *templ;
<a name="l00430"></a>00430     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *action = NULL;
<a name="l00431"></a>00431     <span class="keywordtype">int</span> i;
<a name="l00432"></a>00432     <span class="keywordtype">int</span> ans = -1;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <span class="keywordflow">if</span> (face == NULL || face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> != NULL || face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> != 0)
<a name="l00435"></a>00435         <span class="keywordflow">return</span>(-1);
<a name="l00436"></a>00436     <span class="comment">/* Need to poke the client library here so that it gets the curren time */</span>
<a name="l00437"></a>00437     <a class="code" href="ccn__private_8h.html#aea1c520347cd3a42b97611e84635dcb7" title="Process any scheduled operations that are due.">ccn_process_scheduled_operations</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>);
<a name="l00438"></a>00438     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00439"></a>00439     c = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00440"></a>00440     g = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00441"></a>00441     templ = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00442"></a>00442     <span class="comment">/* Construct a proposed partial guid, without marker bytes */</span>
<a name="l00443"></a>00443     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(g);
<a name="l00444"></a>00444     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(g, 0, 1); <span class="comment">/* 1 reserved byte of zero */</span>
<a name="l00445"></a>00445     <span class="comment">/* The first half is chosen by our side */</span>
<a name="l00446"></a>00446     <span class="keywordflow">for</span> (i = 0; i &lt; 6; i++)
<a name="l00447"></a>00447         <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(g, nrand48(ccnd-&gt;<a class="code" href="structccnd__handle.html#a08e836efa870eb42c0fdba1e08886862" title="for PRNG">seed</a>) &amp; 0xff, 1);
<a name="l00448"></a>00448     <span class="comment">/* The second half will be chosen by the other side */</span>
<a name="l00449"></a>00449     <span class="keywordflow">for</span> (i = 0; i &lt; 6; i++)
<a name="l00450"></a>00450         <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(g, 0, 1);
<a name="l00451"></a>00451     <span class="comment">/* Construct the interest */</span>
<a name="l00452"></a>00452     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(templ);
<a name="l00453"></a>00453     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ac3c02bb032cd835a5f9e439cadd0a455">CCN_DTAG_Interest</a>);
<a name="l00454"></a>00454     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;ccnx:/%C1.M.FACE&quot;</span>);
<a name="l00455"></a>00455     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(templ, name);
<a name="l00456"></a>00456     <span class="comment">/* This interest excludes all but a range of possible guid components */</span>
<a name="l00457"></a>00457     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9dcce1e4306cb7fd0e58d99ef370476e">CCN_DTAG_Exclude</a>);
<a name="l00458"></a>00458     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33adb951474c9a5705b47af838bc536ee24">CCN_DTAG_Any</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00459"></a>00459     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(c);
<a name="l00460"></a>00460     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(c, <span class="stringliteral">&quot;\xC1.M.G&quot;</span>);
<a name="l00461"></a>00461     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(c, 0, 1);
<a name="l00462"></a>00462     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(c, g-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, g-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00463"></a>00463     <a class="code" href="ccn_8h.html#a7cdcd23fbb1b7cc273eb1a680341405f" title="Append a tagged BLOB.">ccnb_append_tagged_blob</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad20ad6d29fb3d5cb3631152e0fc1ccc0">CCN_DTAG_Component</a>, c-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, c-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00464"></a>00464     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(c);
<a name="l00465"></a>00465     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(c, <span class="stringliteral">&quot;\xC1.M.G&quot;</span>);
<a name="l00466"></a>00466     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(c, 0, 1);
<a name="l00467"></a>00467     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(c, g-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, g-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> - 6);
<a name="l00468"></a>00468     <span class="keywordflow">for</span> (i = 0; i &lt; 6; i++)
<a name="l00469"></a>00469         <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(c, 0xff, 1);
<a name="l00470"></a>00470     <a class="code" href="ccn_8h.html#a7cdcd23fbb1b7cc273eb1a680341405f" title="Append a tagged BLOB.">ccnb_append_tagged_blob</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad20ad6d29fb3d5cb3631152e0fc1ccc0">CCN_DTAG_Component</a>, c-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, c-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00471"></a>00471     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33adb951474c9a5705b47af838bc536ee24">CCN_DTAG_Any</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00472"></a>00472     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(templ); <span class="comment">/* Exclude */</span>
<a name="l00473"></a>00473     <span class="comment">/* We don&#39;t want to get confused by cached content */</span>
<a name="l00474"></a>00474     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a67f94b84ea81fc82b7e6a53123998323">CCN_DTAG_AnswerOriginKind</a>, <span class="stringliteral">&quot;%d&quot;</span>, 0);
<a name="l00475"></a>00475     <span class="comment">/* Only talk to direct peers */</span>
<a name="l00476"></a>00476     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a680d2755102e595a0012061fd0b182a8">CCN_DTAG_Scope</a>, <span class="stringliteral">&quot;2&quot;</span>);
<a name="l00477"></a>00477     <span class="comment">/* Bypass the FIB - send to just the face we want */</span>
<a name="l00478"></a>00478     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a721cd5f589aecad951adf514e7f6c3df">CCN_DTAG_FaceID</a>, <span class="stringliteral">&quot;%u&quot;</span>, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00479"></a>00479     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(templ); <span class="comment">/* Interest */</span>
<a name="l00480"></a>00480     action = calloc(1, <span class="keyword">sizeof</span>(*action));
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (action != NULL) {
<a name="l00482"></a>00482         action-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = &amp;<a class="code" href="ccnd__internal__client_8c.html#adf8d85f0c8439422fb6808b39f8bbabb" title="Handle the data that comes back in response to interest sent by send_adjacency_solicit...">solicit_response</a>;
<a name="l00483"></a>00483         action-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> = face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>;
<a name="l00484"></a>00484         action-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = ccnd;
<a name="l00485"></a>00485         ans = <a class="code" href="ccn_8h.html#a9f2d6eede46c8aac3dbb4b6e22e1d492">ccn_express_interest</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>, name, action, templ);
<a name="l00486"></a>00486         <span class="comment">/* Use the guid slot to hold our proposal */</span>
<a name="l00487"></a>00487         <span class="keywordflow">if</span> (ans &gt;= 0)
<a name="l00488"></a>00488             ans = <a class="code" href="ccnd_8c.html#a1e72e448a48f26a6e139a9743aed7021" title="Associate a guid with a face.">ccnd_set_face_guid</a>(ccnd, face, g-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, g-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00489"></a>00489         <span class="keywordflow">if</span> (ans &gt;= 0) {
<a name="l00490"></a>00490             <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#a34846ec88e326ca9e5c469b0fd806bc7">ADJ_SOL_SENT</a>, 0);
<a name="l00491"></a>00491             <a class="code" href="ccnd_8c.html#acd61e0885a9d32e5f380b6025f56f001" title="Schedule the processing of internal client results.">ccnd_internal_client_has_somthing_to_say</a>(ccnd);
<a name="l00492"></a>00492         }
<a name="l00493"></a>00493         ans = (ans &lt; 0) ? -1 : 0;
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00496"></a>00496     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;c);
<a name="l00497"></a>00497     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;g);
<a name="l00498"></a>00498     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;templ);
<a name="l00499"></a>00499     <span class="keywordflow">return</span>(ans);
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 <span class="comment"></span>
<a name="l00502"></a>00502 <span class="comment">/**</span>
<a name="l00503"></a>00503 <span class="comment"> * Scheduled event to call send_adjacency_solicit.</span>
<a name="l00504"></a>00504 <span class="comment"> */</span>
<a name="l00505"></a>00505 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00506"></a><a class="code" href="ccnd__internal__client_8c.html#a6f54064778c00e12489388df9e22cb19">00506</a> <a class="code" href="ccnd__internal__client_8c.html#a6f54064778c00e12489388df9e22cb19" title="Scheduled event to call send_adjacency_solicit.">ccnd_do_solicit</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00507"></a>00507                 <span class="keywordtype">void</span> *clienth,
<a name="l00508"></a>00508                 <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00509"></a>00509                 <span class="keywordtype">int</span> flags)
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511     <span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd = clienth;
<a name="l00512"></a>00512     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = NULL;
<a name="l00513"></a>00513     <span class="keywordtype">unsigned</span> <a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>;
<a name="l00514"></a>00514     <span class="keywordtype">unsigned</span> check, want;
<a name="l00515"></a>00515     
<a name="l00516"></a>00516     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) != 0)
<a name="l00517"></a>00517         <span class="keywordflow">return</span>(0);
<a name="l00518"></a>00518     
<a name="l00519"></a>00519     faceid = ev-&gt;<a class="code" href="structccn__scheduled__event.html#a22f5ee0bc7a266aa2d35ad482cb8c4c3">evint</a>;
<a name="l00520"></a>00520     face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, faceid);
<a name="l00521"></a>00521     <span class="keywordflow">if</span> (face == NULL)
<a name="l00522"></a>00522         <span class="keywordflow">return</span>(0);
<a name="l00523"></a>00523     check = <a class="code" href="ccnd__private_8h.html#a0ea07b6d78ff2694029cd7a34d7d9d3d" title="Connect in progress.">CCN_FACE_CONNECTING</a> | <a class="code" href="ccnd__private_8h.html#a6ff965f1b46a131a7eee2b6e3c3bc5c2" title="Might not be talking ccn.">CCN_FACE_UNDECIDED</a> | <a class="code" href="ccnd__private_8h.html#ac7ede12a840544f26ae1666807d24de8" title="Don&amp;#39;t send anymore.">CCN_FACE_NOSEND</a> |
<a name="l00524"></a>00524             <a class="code" href="ccnd__private_8h.html#af4a2ccfd3378c5fc5728189d2035cc04" title="Considered friendly.">CCN_FACE_GG</a> | <a class="code" href="ccnd__private_8h.html#a1014cdbc05d09bc09af24d2a61938a1c" title="a party line (e.g.">CCN_FACE_MCAST</a> | <a class="code" href="ccnd__private_8h.html#af1baba9e064f70cda67a5a7f80afff9b" title="a listener or a bound dgram socket">CCN_FACE_PASSIVE</a> | <a class="code" href="ccnd__private_8h.html#aecebfd2c4f2d88fbd9f654f767a1787e" title="use for sending only">CCN_FACE_NORECV</a> |
<a name="l00525"></a>00525             <a class="code" href="ccnd__private_8h.html#ab113cb004cb5b502eaed62cbca1a050a">CCN_FACE_BC</a> | <a class="code" href="ccnd__private_8h.html#a0812bb8fb538d1c4cfa366fac505f9a9">CCN_FACE_ADJ</a>;
<a name="l00526"></a>00526     want = 0;
<a name="l00527"></a>00527     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> == 0 &amp;&amp; (face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> &amp; check) == want)
<a name="l00528"></a>00528         <a class="code" href="ccnd__internal__client_8c.html#aa5f2a476a8a1c2fca0b6fae2e7eefa0c" title="Send an adjacency solitiation interest, to elicit an offer from the other side.">send_adjacency_solicit</a>(ccnd, face);
<a name="l00529"></a>00529     <span class="keywordflow">return</span>(0);
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 <span class="comment"></span>
<a name="l00532"></a>00532 <span class="comment">/**</span>
<a name="l00533"></a>00533 <span class="comment"> * Answer an adjacency guid request from any face, based on the guid</span>
<a name="l00534"></a>00534 <span class="comment"> * in the name.</span>
<a name="l00535"></a>00535 <span class="comment"> *</span>
<a name="l00536"></a>00536 <span class="comment"> * @returns CCN_UPCALL_RESULT_INTEREST_CONSUMED if an answer was sent,</span>
<a name="l00537"></a>00537 <span class="comment"> *  otherwise -1.</span>
<a name="l00538"></a>00538 <span class="comment"> */</span>
<a name="l00539"></a>00539 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00540"></a><a class="code" href="ccnd__internal__client_8c.html#a8e0357e8a8c506f01370b27f9d5e0021">00540</a> <a class="code" href="ccnd__internal__client_8c.html#a8e0357e8a8c506f01370b27f9d5e0021" title="Answer an adjacency guid request from any face, based on the guid in the name.">ccnd_answer_by_guid</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = NULL;
<a name="l00543"></a>00543     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> mb[6] = <span class="stringliteral">&quot;\xC1.M.G\x00&quot;</span>;
<a name="l00544"></a>00544     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p = NULL;
<a name="l00545"></a>00545     <span class="keywordtype">size_t</span> size = 0;
<a name="l00546"></a>00546     <span class="keywordtype">unsigned</span> <a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>;
<a name="l00547"></a>00547     <span class="keywordtype">int</span> res;
<a name="l00548"></a>00548     
<a name="l00549"></a>00549     res = <a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, 1,
<a name="l00550"></a>00550                             &amp;p, &amp;size);
<a name="l00551"></a>00551     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00552"></a>00552         <span class="keywordflow">return</span>(-1);
<a name="l00553"></a>00553     <span class="keywordflow">if</span> (size &lt; <span class="keyword">sizeof</span>(mb))
<a name="l00554"></a>00554         <span class="keywordflow">return</span>(-1);
<a name="l00555"></a>00555     <span class="keywordflow">if</span> (memcmp(p, mb, <span class="keyword">sizeof</span>(mb)) != 0)
<a name="l00556"></a>00556         <span class="keywordflow">return</span>(-1);
<a name="l00557"></a>00557     faceid = <a class="code" href="ccnd_8c.html#a9419668b5748f8bb1717b9142229bfb8" title="Return the faceid associated with the guid.">ccnd_faceid_from_guid</a>(ccnd, p + <span class="keyword">sizeof</span>(mb), size - <span class="keyword">sizeof</span>(mb));
<a name="l00558"></a>00558     <span class="keywordflow">if</span> (faceid == <a class="code" href="ccnd__private_8h.html#aa065f01949d39e9cdf018f197151995e">CCN_NOFACEID</a>)
<a name="l00559"></a>00559         <span class="keywordflow">return</span>(-1);
<a name="l00560"></a>00560     face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, faceid);
<a name="l00561"></a>00561     <span class="keywordflow">if</span> (face == NULL)
<a name="l00562"></a>00562         <span class="keywordflow">return</span>(-1);
<a name="l00563"></a>00563     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> &amp; <a class="code" href="ccnd__private_8h.html#a0812bb8fb538d1c4cfa366fac505f9a9">CCN_FACE_ADJ</a>) == 0)
<a name="l00564"></a>00564         <span class="keywordflow">return</span>(-1);
<a name="l00565"></a>00565     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a> == NULL)
<a name="l00566"></a>00566         <a class="code" href="ccnd__internal__client_8c.html#a7208433d97c817cb153e44cf7cd26841" title="Create the adjacency content object for our endpoint of the face.">ccnd_init_face_guid_cob</a>(ccnd, face);
<a name="l00567"></a>00567     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a> == NULL)
<a name="l00568"></a>00568         <span class="keywordflow">return</span>(-1);
<a name="l00569"></a>00569     res = -1;
<a name="l00570"></a>00570     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a2e161e1c17ef110dfa019bc1d560c82c" title="Test for a match between a ContentObject and an Interest.">ccn_content_matches_interest</a>(face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l00571"></a>00571                                      face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l00572"></a>00572                                      1,
<a name="l00573"></a>00573                                      NULL,
<a name="l00574"></a>00574                                      info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>,
<a name="l00575"></a>00575                                      info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>],
<a name="l00576"></a>00576                                      info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>
<a name="l00577"></a>00577                                      )) {
<a name="l00578"></a>00578         <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00579"></a>00579         res = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l00580"></a>00580     }
<a name="l00581"></a>00581     <span class="keywordflow">return</span>(res);
<a name="l00582"></a>00582 }
<a name="l00583"></a>00583 <span class="comment"></span>
<a name="l00584"></a>00584 <span class="comment">/**</span>
<a name="l00585"></a>00585 <span class="comment"> * Handle the data comming back from an adjacency offer or commit request.</span>
<a name="l00586"></a>00586 <span class="comment"> */</span>
<a name="l00587"></a>00587 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00588"></a><a class="code" href="ccnd__internal__client_8c.html#ab7d3aa146688349e1e97a21c91e59bcb">00588</a> <a class="code" href="ccnd__internal__client_8c.html#ab7d3aa146688349e1e97a21c91e59bcb" title="Handle the data comming back from an adjacency offer or commit request.">incoming_adjacency</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00589"></a>00589                    <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00590"></a>00590                    <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info)
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = NULL;
<a name="l00593"></a>00593     <span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd = selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l00594"></a>00594     <span class="keywordflow">switch</span> (kind) {
<a name="l00595"></a>00595         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92ad00afdf8a89c718f4c451600b115b5e0" title="handler is about to be deregistered">CCN_UPCALL_FINAL</a>:
<a name="l00596"></a>00596             free(selfp);
<a name="l00597"></a>00597             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00598"></a>00598         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a28260b0a25b7046e6930f0b13a718db0" title="incoming verified content">CCN_UPCALL_CONTENT</a>:
<a name="l00599"></a>00599             face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a>);
<a name="l00600"></a>00600             <span class="keywordflow">if</span> (face == NULL)
<a name="l00601"></a>00601                 <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00602"></a>00602             <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#aa85b9730b33d5be316e5254999d64e5b">ADJ_TIMEDWAIT</a>)) != 0)
<a name="l00603"></a>00603                 <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00604"></a>00604             <span class="comment">/* XXX - this should scrutinize the data to make sure it is OK */</span>
<a name="l00605"></a>00605             <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#a85bb13ed7768c40b10ef5b03a1fc7d1d">ADJ_OFR_SENT</a> | <a class="code" href="ccnd__internal__client_8c.html#adc41a64e5dd78c6c23bcad43c624b199">ADJ_CRQ_SENT</a>)) != 0)
<a name="l00606"></a>00606                 <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#afc9a19612aee413b9cfc53d9af752bcc">ADJ_DAT_RECV</a>, 0);
<a name="l00607"></a>00607             <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, 0, <a class="code" href="ccnd__internal__client_8c.html#ac72f442caacce475c82e41c82e71e64b">ADJ_PINGING</a> | <a class="code" href="ccnd__internal__client_8c.html#aa3e6a44172ac5b43333b7613210c4ccb">ADJ_RETRYING</a>);
<a name="l00608"></a>00608             <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#a85aaca3a09dc18b82ac76353f5ba5e9c">ADJ_CRQ_RECV</a>)) != 0 &amp;&amp;
<a name="l00609"></a>00609                 (face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#a14825114770d32358ba3728d4e351bbe">ADJ_DAT_SENT</a>)) == 0 &amp;&amp;
<a name="l00610"></a>00610                 face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a> != 0) {
<a name="l00611"></a>00611                 <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l00612"></a>00612                                  face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00613"></a>00613                 <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#a14825114770d32358ba3728d4e351bbe">ADJ_DAT_SENT</a>, 0);
<a name="l00614"></a>00614                 <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#afc9a19612aee413b9cfc53d9af752bcc">ADJ_DAT_RECV</a>)) == 0)
<a name="l00615"></a>00615                     <a class="code" href="ccnd__internal__client_8c.html#aadecfbdfe316a850a93580c4499ebc9c" title="Express an interest to pull adjacency information from the other side.">ccnd_adjacency_offer_or_commit_req</a>(ccnd, face);
<a name="l00616"></a>00616             }
<a name="l00617"></a>00617             <a class="code" href="ccnd__internal__client_8c.html#ac13ee3828f4674ea216d0d84574bc7dc" title="Register the adjacency prefix with the given forwarding flags.">ccnd_register_adjacency</a>(ccnd, face,
<a name="l00618"></a>00618                                     <a class="code" href="reg__mgmt_8h.html#a38f4b34f7297b60fd82b57a6ce62d44f">CCN_FORW_CHILD_INHERIT</a> | <a class="code" href="reg__mgmt_8h.html#ae0ad3c46c8762dc3117420b77af96249" title="Refer to doc/technical/Registration.txt for the meaning of these flags.">CCN_FORW_ACTIVE</a>);
<a name="l00619"></a>00619             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00620"></a>00620         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a3c7ef9861eb5ba1529b4d05630e83c88" title="interest timed out">CCN_UPCALL_INTEREST_TIMED_OUT</a>:
<a name="l00621"></a>00621             face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a>);
<a name="l00622"></a>00622             <span class="keywordflow">if</span> (face == NULL)
<a name="l00623"></a>00623                 <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00624"></a>00624             <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#aa3e6a44172ac5b43333b7613210c4ccb">ADJ_RETRYING</a> | <a class="code" href="ccnd__internal__client_8c.html#aa85b9730b33d5be316e5254999d64e5b">ADJ_TIMEDWAIT</a>)) == 0) {
<a name="l00625"></a>00625                 <span class="comment">/* Retry one time */</span>
<a name="l00626"></a>00626                 <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#aa3e6a44172ac5b43333b7613210c4ccb">ADJ_RETRYING</a>, 0);
<a name="l00627"></a>00627                 <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca686785df48ac222ef31beea39eebd404" title="reexpress the same interest again">CCN_UPCALL_RESULT_REEXPRESS</a>);
<a name="l00628"></a>00628             }
<a name="l00629"></a>00629             <a class="code" href="ccnd__internal__client_8c.html#a630c2ae086977fdf3781944b6d4c453b" title="Schedule recovery from a broken adjacency negotiation.">adjacency_timed_reset</a>(ccnd, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00630"></a>00630             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00631"></a>00631         <span class="keywordflow">default</span>:
<a name="l00632"></a>00632             face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a>);
<a name="l00633"></a>00633             <span class="keywordflow">if</span> (face != NULL)
<a name="l00634"></a>00634                 <a class="code" href="ccnd__internal__client_8c.html#a630c2ae086977fdf3781944b6d4c453b" title="Schedule recovery from a broken adjacency negotiation.">adjacency_timed_reset</a>(ccnd, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00635"></a>00635             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00636"></a>00636     }
<a name="l00637"></a>00637 }
<a name="l00638"></a>00638 <span class="comment"></span>
<a name="l00639"></a>00639 <span class="comment">/**</span>
<a name="l00640"></a>00640 <span class="comment"> * Express an interest to pull adjacency information from the other side</span>
<a name="l00641"></a>00641 <span class="comment"> */</span>
<a name="l00642"></a>00642 <span class="keywordtype">void</span>
<a name="l00643"></a><a class="code" href="ccnd__private_8h.html#aadecfbdfe316a850a93580c4499ebc9c">00643</a> <a class="code" href="ccnd__internal__client_8c.html#aadecfbdfe316a850a93580c4499ebc9c" title="Express an interest to pull adjacency information from the other side.">ccnd_adjacency_offer_or_commit_req</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keyword">struct</span> <a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a>)
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name;
<a name="l00646"></a>00646     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *c;
<a name="l00647"></a>00647     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *templ;
<a name="l00648"></a>00648     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *action = NULL;
<a name="l00649"></a>00649     
<a name="l00650"></a>00650     <span class="keywordflow">if</span> (face == NULL || face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> == NULL)
<a name="l00651"></a>00651         <span class="keywordflow">return</span>;
<a name="l00652"></a>00652     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#a34846ec88e326ca9e5c469b0fd806bc7">ADJ_SOL_SENT</a> | <a class="code" href="ccnd__internal__client_8c.html#aa85b9730b33d5be316e5254999d64e5b">ADJ_TIMEDWAIT</a>)) != 0)
<a name="l00653"></a>00653         <span class="keywordflow">return</span>;
<a name="l00654"></a>00654     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#ac72f442caacce475c82e41c82e71e64b">ADJ_PINGING</a>)) != 0)
<a name="l00655"></a>00655         <span class="keywordflow">return</span>;
<a name="l00656"></a>00656     <span class="comment">/* Need to poke the client library here so that it gets the current time */</span>
<a name="l00657"></a>00657     <a class="code" href="ccn__private_8h.html#aea1c520347cd3a42b97611e84635dcb7" title="Process any scheduled operations that are due.">ccn_process_scheduled_operations</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>);
<a name="l00658"></a>00658     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00659"></a>00659     c = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00660"></a>00660     templ = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00661"></a>00661     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;ccnx:/%C1.M.FACE&quot;</span>);
<a name="l00662"></a>00662     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(c);
<a name="l00663"></a>00663     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(c, <span class="stringliteral">&quot;\xC1.M.G&quot;</span>);
<a name="l00664"></a>00664     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(c, 0, 1);
<a name="l00665"></a>00665     <a class="code" href="ccnd_8c.html#a8dcea631c5a6900917f4282991ee3044" title="Append the guid associated with a face to a charbuf.">ccnd_append_face_guid</a>(ccnd, c, face);
<a name="l00666"></a>00666     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, c-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, c-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00667"></a>00667     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;%C1.M.NODE&quot;</span>);
<a name="l00668"></a>00668     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(templ);
<a name="l00669"></a>00669     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ac3c02bb032cd835a5f9e439cadd0a455">CCN_DTAG_Interest</a>);
<a name="l00670"></a>00670     <a class="code" href="charbuf_8h.html#aca88638b2e81602eb4a1da9be923dad7">ccn_charbuf_append_charbuf</a>(templ, name);
<a name="l00671"></a>00671     <a class="code" href="ccn_8h.html#afc2eb536e63f315968abe901e52b506a" title="Append a start-of-element marker.">ccnb_element_begin</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a9dcce1e4306cb7fd0e58d99ef370476e">CCN_DTAG_Exclude</a>);
<a name="l00672"></a>00672     <a class="code" href="charbuf_8h.html#aa0cf436e626f2e8d0fefeaed179676de">ccn_charbuf_reset</a>(c);
<a name="l00673"></a>00673     <a class="code" href="charbuf_8h.html#a12190393f4067f51977b2d702ae6d8a4">ccn_charbuf_append_string</a>(c, <span class="stringliteral">&quot;\xC1.M.K&quot;</span>);
<a name="l00674"></a>00674     <a class="code" href="charbuf_8h.html#a81295ee9f650331a09e9742422faa0e7">ccn_charbuf_append_value</a>(c, 0, 1);
<a name="l00675"></a>00675     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(c, ccnd-&gt;<a class="code" href="structccnd__handle.html#a935a4fbf6e79b677d425d49661326e7e" title="sha256 digest of our public key">ccnd_id</a>, <span class="keyword">sizeof</span>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a935a4fbf6e79b677d425d49661326e7e" title="sha256 digest of our public key">ccnd_id</a>));
<a name="l00676"></a>00676     <a class="code" href="ccn_8h.html#a7cdcd23fbb1b7cc273eb1a680341405f" title="Append a tagged BLOB.">ccnb_append_tagged_blob</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33ad20ad6d29fb3d5cb3631152e0fc1ccc0">CCN_DTAG_Component</a>, c-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, c-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00677"></a>00677     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(templ); <span class="comment">/* Exclude */</span>
<a name="l00678"></a>00678     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a67f94b84ea81fc82b7e6a53123998323">CCN_DTAG_AnswerOriginKind</a>, <span class="stringliteral">&quot;%d&quot;</span>, 0);
<a name="l00679"></a>00679     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a680d2755102e595a0012061fd0b182a8">CCN_DTAG_Scope</a>, <span class="stringliteral">&quot;2&quot;</span>);
<a name="l00680"></a>00680     <a class="code" href="ccn_8h.html#a10b8c6dc48e4640be33c90d983d3cb81" title="Append a tagged UDATA string, with printf-style formatting.">ccnb_tagged_putf</a>(templ, <a class="code" href="coding_8h.html#a720ee1182276ef229dcf775366d84f33a721cd5f589aecad951adf514e7f6c3df">CCN_DTAG_FaceID</a>, <span class="stringliteral">&quot;%u&quot;</span>, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00681"></a>00681     <a class="code" href="ccn_8h.html#aa46b72f2e6b3b7f7753ff3baaa4efdf8" title="Append an end-of-element marker.">ccnb_element_end</a>(templ); <span class="comment">/* Interest */</span>
<a name="l00682"></a>00682     action = calloc(1, <span class="keyword">sizeof</span>(*action));
<a name="l00683"></a>00683     <span class="keywordflow">if</span> (action != NULL) {
<a name="l00684"></a>00684         action-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = &amp;<a class="code" href="ccnd__internal__client_8c.html#ab7d3aa146688349e1e97a21c91e59bcb" title="Handle the data comming back from an adjacency offer or commit request.">incoming_adjacency</a>;
<a name="l00685"></a>00685         action-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> = face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>;
<a name="l00686"></a>00686         action-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = ccnd;
<a name="l00687"></a>00687         <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#ac72f442caacce475c82e41c82e71e64b">ADJ_PINGING</a>, <a class="code" href="ccnd__internal__client_8c.html#aa3e6a44172ac5b43333b7613210c4ccb">ADJ_RETRYING</a>);
<a name="l00688"></a>00688         <a class="code" href="ccn_8h.html#a9f2d6eede46c8aac3dbb4b6e22e1d492">ccn_express_interest</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>, name, action, templ);
<a name="l00689"></a>00689         <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; <a class="code" href="ccnd__internal__client_8c.html#abd0487488ae47a4ae7497ca20f0c9aba">ADJ_OFR_RECV</a>) != 0)
<a name="l00690"></a>00690             <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#adc41a64e5dd78c6c23bcad43c624b199">ADJ_CRQ_SENT</a>, 0);
<a name="l00691"></a>00691         <span class="keywordflow">else</span>
<a name="l00692"></a>00692             <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#a85bb13ed7768c40b10ef5b03a1fc7d1d">ADJ_OFR_SENT</a>, 0);
<a name="l00693"></a>00693     }
<a name="l00694"></a>00694     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00695"></a>00695     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;c);
<a name="l00696"></a>00696     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;templ);
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 <span class="comment"></span>
<a name="l00699"></a>00699 <span class="comment">/**</span>
<a name="l00700"></a>00700 <span class="comment"> * Determine whether an offer matches up with our solicitation.</span>
<a name="l00701"></a>00701 <span class="comment"> */</span>
<a name="l00702"></a>00702 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00703"></a><a class="code" href="ccnd__internal__client_8c.html#ac8cd07d90678a93a68ad2cb245adf687">00703</a> <a class="code" href="ccnd__internal__client_8c.html#ac8cd07d90678a93a68ad2cb245adf687" title="Determine whether an offer matches up with our solicitation.">check_offer_matches_my_solicit</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keyword">struct</span> <a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a>,
<a name="l00704"></a>00704                                <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info)
<a name="l00705"></a>00705 {
<a name="l00706"></a>00706     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = NULL;
<a name="l00707"></a>00707     <span class="keywordtype">size_t</span> size = 0;
<a name="l00708"></a>00708     <span class="keywordtype">int</span> res;
<a name="l00709"></a>00709     <span class="keyword">const</span> <span class="keywordtype">char</span> *mg = <span class="stringliteral">&quot;\xC1.M.G&quot;</span>;
<a name="l00710"></a>00710     <span class="keyword">const</span> <span class="keywordtype">char</span> *mn = <span class="stringliteral">&quot;\xC1.M.NODE&quot;</span>;
<a name="l00711"></a>00711     
<a name="l00712"></a>00712     <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#af8e2d2c628b4b7bdb82de9edf8f91042">prefix_comps</a> != 3)
<a name="l00713"></a>00713         <span class="keywordflow">return</span>;
<a name="l00714"></a>00714     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; <a class="code" href="ccnd__internal__client_8c.html#a34846ec88e326ca9e5c469b0fd806bc7">ADJ_SOL_SENT</a>) == 0)
<a name="l00715"></a>00715         <span class="keywordflow">return</span>;
<a name="l00716"></a>00716     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> == NULL)
<a name="l00717"></a>00717         <span class="keywordflow">return</span>;
<a name="l00718"></a>00718     res = <a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, 2,
<a name="l00719"></a>00719                             &amp;p, &amp;size);
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00721"></a>00721         <span class="keywordflow">return</span>;
<a name="l00722"></a>00722     <span class="keywordflow">if</span> (size != strlen(mn) || 0 != memcmp(p, mn, size))
<a name="l00723"></a>00723         <span class="keywordflow">return</span>;
<a name="l00724"></a>00724     res = <a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>, 1,
<a name="l00725"></a>00725                             &amp;p, &amp;size);
<a name="l00726"></a>00726     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00727"></a>00727         <span class="keywordflow">return</span>;
<a name="l00728"></a>00728     res = strlen(mg) + 1;
<a name="l00729"></a>00729     <span class="keywordflow">if</span> (size != res + face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a>[0] || face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a>[0] &lt;= 6)
<a name="l00730"></a>00730         <span class="keywordflow">return</span>;
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (0 != memcmp(p, mg, res))
<a name="l00732"></a>00732         <span class="keywordflow">return</span>;
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (0 != memcmp(p + res, face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> + 1, face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a>[0] - 6))
<a name="l00734"></a>00734         <span class="keywordflow">return</span>;
<a name="l00735"></a>00735     <a class="code" href="ccnd_8c.html#a77f6fcf336938985eafd10fe085ad0ce" title="Forget the guid associated with a face.">ccnd_forget_face_guid</a>(ccnd, face);
<a name="l00736"></a>00736     <a class="code" href="ccnd_8c.html#a1e72e448a48f26a6e139a9743aed7021" title="Associate a guid with a face.">ccnd_set_face_guid</a>(ccnd, face, p + res, size - res);
<a name="l00737"></a>00737     <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#abd0487488ae47a4ae7497ca20f0c9aba">ADJ_OFR_RECV</a>, <a class="code" href="ccnd__internal__client_8c.html#a34846ec88e326ca9e5c469b0fd806bc7">ADJ_SOL_SENT</a>);
<a name="l00738"></a>00738 }
<a name="l00739"></a>00739 <span class="comment"></span>
<a name="l00740"></a>00740 <span class="comment">/**</span>
<a name="l00741"></a>00741 <span class="comment"> * Schedule negotiation of a link guid if appropriate</span>
<a name="l00742"></a>00742 <span class="comment"> */</span>
<a name="l00743"></a>00743 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00744"></a><a class="code" href="ccnd__internal__client_8c.html#ae28569a32965b42d7bfb047b9baa00c1">00744</a> <a class="code" href="ccnd__internal__client_8c.html#ae28569a32965b42d7bfb047b9baa00c1" title="Schedule negotiation of a link guid if appropriate.">schedule_adjacency_negotiation</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keywordtype">unsigned</span> faceid)
<a name="l00745"></a>00745 {
<a name="l00746"></a>00746     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, faceid);
<a name="l00747"></a>00747     <span class="keywordtype">unsigned</span> check, want;
<a name="l00748"></a>00748     <span class="keywordtype">int</span> delay;
<a name="l00749"></a>00749     
<a name="l00750"></a>00750     <span class="keywordflow">if</span> (face == NULL)
<a name="l00751"></a>00751         <span class="keywordflow">return</span>;
<a name="l00752"></a>00752     check = <a class="code" href="ccnd__private_8h.html#a0ea07b6d78ff2694029cd7a34d7d9d3d" title="Connect in progress.">CCN_FACE_CONNECTING</a> | <a class="code" href="ccnd__private_8h.html#a6ff965f1b46a131a7eee2b6e3c3bc5c2" title="Might not be talking ccn.">CCN_FACE_UNDECIDED</a> | <a class="code" href="ccnd__private_8h.html#ac7ede12a840544f26ae1666807d24de8" title="Don&amp;#39;t send anymore.">CCN_FACE_NOSEND</a> |
<a name="l00753"></a>00753             <a class="code" href="ccnd__private_8h.html#af4a2ccfd3378c5fc5728189d2035cc04" title="Considered friendly.">CCN_FACE_GG</a> | <a class="code" href="ccnd__private_8h.html#a1014cdbc05d09bc09af24d2a61938a1c" title="a party line (e.g.">CCN_FACE_MCAST</a> | <a class="code" href="ccnd__private_8h.html#af1baba9e064f70cda67a5a7f80afff9b" title="a listener or a bound dgram socket">CCN_FACE_PASSIVE</a> | <a class="code" href="ccnd__private_8h.html#aecebfd2c4f2d88fbd9f654f767a1787e" title="use for sending only">CCN_FACE_NORECV</a> |
<a name="l00754"></a>00754             <a class="code" href="ccnd__private_8h.html#ab113cb004cb5b502eaed62cbca1a050a">CCN_FACE_BC</a> | <a class="code" href="ccnd__private_8h.html#a0812bb8fb538d1c4cfa366fac505f9a9">CCN_FACE_ADJ</a>;
<a name="l00755"></a>00755     want = 0;
<a name="l00756"></a>00756     <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a> != NULL &amp;&amp; (face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> &amp; check) == want) {
<a name="l00757"></a>00757         <span class="comment">/* If face creation was initiated remotely, dally a bit longer. */</span>
<a name="l00758"></a>00758         delay = 2000 + nrand48(ccnd-&gt;<a class="code" href="structccnd__handle.html#a08e836efa870eb42c0fdba1e08886862" title="for PRNG">seed</a>) % 131072U;
<a name="l00759"></a>00759         <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> &amp; <a class="code" href="ccnd__private_8h.html#a459d9b6dc2c5df1b0054f4131648d01c" title="No timeout for inactivity.">CCN_FACE_PERMANENT</a>) == 0)
<a name="l00760"></a>00760             delay += 200000;
<a name="l00761"></a>00761         <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a>, delay, <a class="code" href="ccnd__internal__client_8c.html#a6f54064778c00e12489388df9e22cb19" title="Scheduled event to call send_adjacency_solicit.">ccnd_do_solicit</a>, NULL, faceid);
<a name="l00762"></a>00762     }
<a name="l00763"></a>00763 }
<a name="l00764"></a>00764 <span class="comment"></span>
<a name="l00765"></a>00765 <span class="comment">/**</span>
<a name="l00766"></a>00766 <span class="comment"> * Scheduled event for recovering from a broken adjacency negotiation</span>
<a name="l00767"></a>00767 <span class="comment"> */</span>
<a name="l00768"></a>00768 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00769"></a><a class="code" href="ccnd__internal__client_8c.html#a194daea4aed97ab1f9e68a96028f2946">00769</a> <a class="code" href="ccnd__internal__client_8c.html#a194daea4aed97ab1f9e68a96028f2946" title="Scheduled event for recovering from a broken adjacency negotiation.">adjacency_do_reset</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l00770"></a>00770                    <span class="keywordtype">void</span> *clienth,
<a name="l00771"></a>00771                    <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l00772"></a>00772                    <span class="keywordtype">int</span> <a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a>)
<a name="l00773"></a>00773 {
<a name="l00774"></a>00774     <span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd = clienth;
<a name="l00775"></a>00775     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = NULL;
<a name="l00776"></a>00776     
<a name="l00777"></a>00777     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) != 0)
<a name="l00778"></a>00778         <span class="keywordflow">return</span>(0);
<a name="l00779"></a>00779     face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, ev-&gt;<a class="code" href="structccn__scheduled__event.html#a22f5ee0bc7a266aa2d35ad482cb8c4c3">evint</a>);
<a name="l00780"></a>00780     <span class="keywordflow">if</span> (face == NULL)
<a name="l00781"></a>00781         <span class="keywordflow">return</span>(0);
<a name="l00782"></a>00782     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; <a class="code" href="ccnd__internal__client_8c.html#aa85b9730b33d5be316e5254999d64e5b">ADJ_TIMEDWAIT</a>) == 0)
<a name="l00783"></a>00783         <span class="keywordflow">return</span>(0);
<a name="l00784"></a>00784     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> != <a class="code" href="ccnd__internal__client_8c.html#aa85b9730b33d5be316e5254999d64e5b">ADJ_TIMEDWAIT</a>) {
<a name="l00785"></a>00785         <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#aa85b9730b33d5be316e5254999d64e5b">ADJ_TIMEDWAIT</a>, ~<a class="code" href="ccnd__internal__client_8c.html#ac982c06643f5c679d785fc020cf25e29">ADJ_ACTIVE</a>);
<a name="l00786"></a>00786         <a class="code" href="ccnd_8c.html#a77f6fcf336938985eafd10fe085ad0ce" title="Forget the guid associated with a face.">ccnd_forget_face_guid</a>(ccnd, face);
<a name="l00787"></a>00787         <span class="keywordflow">return</span>(666666);
<a name="l00788"></a>00788     }
<a name="l00789"></a>00789     <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, 0, ~0);
<a name="l00790"></a>00790     <a class="code" href="ccnd__internal__client_8c.html#ae28569a32965b42d7bfb047b9baa00c1" title="Schedule negotiation of a link guid if appropriate.">schedule_adjacency_negotiation</a>(ccnd, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l00791"></a>00791     <span class="keywordflow">return</span>(0);
<a name="l00792"></a>00792 }
<a name="l00793"></a>00793 <span class="comment"></span>
<a name="l00794"></a>00794 <span class="comment">/**</span>
<a name="l00795"></a>00795 <span class="comment"> * Schedule recovery from a broken adjacency negotiation</span>
<a name="l00796"></a>00796 <span class="comment"> */</span>
<a name="l00797"></a>00797 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00798"></a><a class="code" href="ccnd__internal__client_8c.html#a630c2ae086977fdf3781944b6d4c453b">00798</a> <a class="code" href="ccnd__internal__client_8c.html#a630c2ae086977fdf3781944b6d4c453b" title="Schedule recovery from a broken adjacency negotiation.">adjacency_timed_reset</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keywordtype">unsigned</span> <a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>)
<a name="l00799"></a>00799 {
<a name="l00800"></a>00800     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, faceid);
<a name="l00801"></a>00801     
<a name="l00802"></a>00802     <span class="keywordflow">if</span> (face == NULL || ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a> == NULL)
<a name="l00803"></a>00803         <span class="keywordflow">return</span>;
<a name="l00804"></a>00804     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> &amp; <a class="code" href="ccnd__private_8h.html#a0812bb8fb538d1c4cfa366fac505f9a9">CCN_FACE_ADJ</a>) != 0) {
<a name="l00805"></a>00805         <a class="code" href="ccnd__internal__client_8c.html#a9a8312e047d60e5e17dbe0f248ada546" title="Called by ccnd when a face undergoes a substantive status change that should be reported...">ccnd_face_status_change</a>(ccnd, faceid);
<a name="l00806"></a>00806         face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> &amp;= ~<a class="code" href="ccnd__private_8h.html#a0812bb8fb538d1c4cfa366fac505f9a9">CCN_FACE_ADJ</a>;
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808     <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#aa85b9730b33d5be316e5254999d64e5b">ADJ_TIMEDWAIT</a>, ~<a class="code" href="ccnd__internal__client_8c.html#ac982c06643f5c679d785fc020cf25e29">ADJ_ACTIVE</a>);
<a name="l00809"></a>00809     <a class="code" href="ccnd_8c.html#a77f6fcf336938985eafd10fe085ad0ce" title="Forget the guid associated with a face.">ccnd_forget_face_guid</a>(ccnd, face);
<a name="l00810"></a>00810     <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a>, 9000000 + nrand48(ccnd-&gt;<a class="code" href="structccnd__handle.html#a08e836efa870eb42c0fdba1e08886862" title="for PRNG">seed</a>) % 8000000U,
<a name="l00811"></a>00811                        <a class="code" href="ccnd__internal__client_8c.html#a194daea4aed97ab1f9e68a96028f2946" title="Scheduled event for recovering from a broken adjacency negotiation.">adjacency_do_reset</a>, NULL, faceid);
<a name="l00812"></a>00812 }
<a name="l00813"></a>00813 <span class="comment"></span>
<a name="l00814"></a>00814 <span class="comment">/**</span>
<a name="l00815"></a>00815 <span class="comment"> * Local interpretation of selfp-&gt;intdata</span>
<a name="l00816"></a>00816 <span class="comment"> */</span>
<a name="l00817"></a><a class="code" href="ccnd__internal__client_8c.html#a2a7766bb8968e9917d4446118305a3de">00817</a> <span class="preprocessor">#define MORECOMPS_MASK 0x007F</span>
<a name="l00818"></a><a class="code" href="ccnd__internal__client_8c.html#a9b5ffa374de63b291650d975448a17d8">00818</a> <span class="preprocessor"></span><span class="preprocessor">#define MUST_VERIFY    0x0080</span>
<a name="l00819"></a><a class="code" href="ccnd__internal__client_8c.html#a54fdd3bbf59345b3496d6b1628c9e30d">00819</a> <span class="preprocessor"></span><span class="preprocessor">#define MUST_VERIFY1   (MUST_VERIFY + 1)</span>
<a name="l00820"></a><a class="code" href="ccnd__internal__client_8c.html#ada4b17f9699213bd7f57614800256ef3">00820</a> <span class="preprocessor"></span><span class="preprocessor">#define OPER_MASK      0xFF00</span>
<a name="l00821"></a><a class="code" href="ccnd__internal__client_8c.html#a01aaa9cdf37bfba6b05e4465abe182c6">00821</a> <span class="preprocessor"></span><span class="preprocessor">#define OP_PING        0x0000</span>
<a name="l00822"></a><a class="code" href="ccnd__internal__client_8c.html#af61c9112fc18285a11dcdc19bb2eb5d2">00822</a> <span class="preprocessor"></span><span class="preprocessor">#define OP_NEWFACE     0x0200</span>
<a name="l00823"></a><a class="code" href="ccnd__internal__client_8c.html#a7dd9285eeab9793dfd5033cf7353aa38">00823</a> <span class="preprocessor"></span><span class="preprocessor">#define OP_DESTROYFACE 0x0300</span>
<a name="l00824"></a><a class="code" href="ccnd__internal__client_8c.html#a86a8ce41e90e0acf5186b6846005163a">00824</a> <span class="preprocessor"></span><span class="preprocessor">#define OP_PREFIXREG   0x0400</span>
<a name="l00825"></a><a class="code" href="ccnd__internal__client_8c.html#a7403c633c199ae5fdb285d51c445a466">00825</a> <span class="preprocessor"></span><span class="preprocessor">#define OP_SELFREG     0x0500</span>
<a name="l00826"></a><a class="code" href="ccnd__internal__client_8c.html#a00eb5f887f0faa76fae2ab76fa23bf4b">00826</a> <span class="preprocessor"></span><span class="preprocessor">#define OP_UNREG       0x0600</span>
<a name="l00827"></a><a class="code" href="ccnd__internal__client_8c.html#a5d793d91c901b7b88f493fa05248b573">00827</a> <span class="preprocessor"></span><span class="preprocessor">#define OP_NOTICE      0x0700</span>
<a name="l00828"></a><a class="code" href="ccnd__internal__client_8c.html#a87c25a5cbf8056c45500ea18f8cc6954">00828</a> <span class="preprocessor"></span><span class="preprocessor">#define OP_SERVICE     0x0800</span>
<a name="l00829"></a><a class="code" href="ccnd__internal__client_8c.html#acd6be347ddcb8be409557b4b0dcf5d94">00829</a> <span class="preprocessor"></span><span class="preprocessor">#define OP_ADJACENCY   0x0900</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00831"></a>00831 <span class="comment">/**</span>
<a name="l00832"></a>00832 <span class="comment"> * Common interest handler for ccnd_internal_client</span>
<a name="l00833"></a>00833 <span class="comment"> */</span>
<a name="l00834"></a>00834 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddc" title="Upcalls return one of these values.">ccn_upcall_res</a>
<a name="l00835"></a><a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533">00835</a> <a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>(<span class="keyword">struct</span> <a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *selfp,
<a name="l00836"></a>00836                  <span class="keyword">enum</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92" title="This tells what kind of event the upcall is handling.">ccn_upcall_kind</a> kind,
<a name="l00837"></a>00837                  <span class="keyword">struct</span> <a class="code" href="structccn__upcall__info.html" title="Additional information provided in the upcall.">ccn_upcall_info</a> *info)
<a name="l00838"></a>00838 {
<a name="l00839"></a>00839     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *msg = NULL;
<a name="l00840"></a>00840     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l00841"></a>00841     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *keylocator = NULL;
<a name="l00842"></a>00842     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *signed_info = NULL;
<a name="l00843"></a>00843     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *reply_body = NULL;
<a name="l00844"></a>00844     <span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd = NULL;
<a name="l00845"></a>00845     <span class="keywordtype">int</span> res = 0;
<a name="l00846"></a>00846     <span class="keywordtype">int</span> start = 0;
<a name="l00847"></a>00847     <span class="keywordtype">int</span> end = 0;
<a name="l00848"></a>00848     <span class="keywordtype">int</span> morecomps = 0;
<a name="l00849"></a>00849     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *final_comp = NULL;
<a name="l00850"></a>00850     <span class="keywordtype">size_t</span> final_size = 0;
<a name="l00851"></a>00851     <span class="keyword">struct </span><a class="code" href="structccn__signing__params.html" title="Parameters for creating signed content objects.">ccn_signing_params</a> sp = <a class="code" href="ccn_8h.html#a4ff046ac820ac0f2ef6acb912a03b328">CCN_SIGNING_PARAMS_INIT</a>;
<a name="l00852"></a>00852     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = NULL;
<a name="l00853"></a>00853     
<a name="l00854"></a>00854     <span class="keywordflow">switch</span> (kind) {
<a name="l00855"></a>00855         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92ad00afdf8a89c718f4c451600b115b5e0" title="handler is about to be deregistered">CCN_UPCALL_FINAL</a>:
<a name="l00856"></a>00856             free(selfp);
<a name="l00857"></a>00857             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00858"></a>00858         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a10dc20968eaf28989921d076bbc81d62" title="incoming interest">CCN_UPCALL_INTEREST</a>:
<a name="l00859"></a>00859             <span class="keywordflow">break</span>;
<a name="l00860"></a>00860         <span class="keywordflow">case</span> <a class="code" href="ccn_8h.html#a5fcebad21626ea80c67775c092011c92a01b7a7469d45ecef00337246a3a24d59" title="incoming interest, someone has answered">CCN_UPCALL_CONSUMED_INTEREST</a>:
<a name="l00861"></a>00861             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00862"></a>00862         <span class="keywordflow">default</span>:
<a name="l00863"></a>00863             <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>);
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865     ccnd = (<span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *)selfp-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a>;
<a name="l00866"></a>00866     if ((ccnd-&gt;<a class="code" href="structccnd__handle.html#af1f782a44b7c5da14c5608974cc7677c" title="For controlling debug output.">debug</a> &amp; 128) != 0)
<a name="l00867"></a>00867         <a class="code" href="ccnd__msg_8c.html#ad401ad085e447112e5916594874b566e" title="Produce a ccnd debug trace entry.">ccnd_debug_ccnb</a>(ccnd, __LINE__, <span class="stringliteral">&quot;ccnd_answer_req&quot;</span>, NULL,
<a name="l00868"></a>00868                         info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00869"></a>00869     morecomps = selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> &amp; <a class="code" href="ccnd__internal__client_8c.html#a2a7766bb8968e9917d4446118305a3de" title="Local interpretation of selfp-&amp;gt;intdata.">MORECOMPS_MASK</a>;
<a name="l00870"></a>00870     <span class="keywordflow">if</span> ((info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#a0c535d59cbe268b169381219513d54c4">answerfrom</a> &amp; <a class="code" href="ccn_8h.html#a2eee6f7928f301760a9fe253faf676b3">CCN_AOK_NEW</a>) == 0 &amp;&amp;
<a name="l00871"></a>00871         selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> != <a class="code" href="ccnd__internal__client_8c.html#a87c25a5cbf8056c45500ea18f8cc6954">OP_SERVICE</a> &amp;&amp;
<a name="l00872"></a>00872         selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> != <a class="code" href="ccnd__internal__client_8c.html#a5d793d91c901b7b88f493fa05248b573">OP_NOTICE</a> &amp;&amp;
<a name="l00873"></a>00873         selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> != <a class="code" href="ccnd__internal__client_8c.html#acd6be347ddcb8be409557b4b0dcf5d94">OP_ADJACENCY</a>)
<a name="l00874"></a>00874         <span class="keywordflow">return</span>(<a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddcadadb47635316f12c6542c33cebcfa727" title="normal upcall return">CCN_UPCALL_RESULT_OK</a>);
<a name="l00875"></a>00875     <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structccn__upcall__info.html#a03ad6fed84681d245643cbe9019db015">matched_comps</a> &gt;= info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a>)
<a name="l00876"></a>00876         <span class="keywordflow">goto</span> Bail;
<a name="l00877"></a>00877     <span class="keywordflow">if</span> (selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> != <a class="code" href="ccnd__internal__client_8c.html#a01aaa9cdf37bfba6b05e4465abe182c6">OP_PING</a> &amp;&amp;
<a name="l00878"></a>00878         selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> != <a class="code" href="ccnd__internal__client_8c.html#a5d793d91c901b7b88f493fa05248b573">OP_NOTICE</a> &amp;&amp;
<a name="l00879"></a>00879         selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> != <a class="code" href="ccnd__internal__client_8c.html#a87c25a5cbf8056c45500ea18f8cc6954">OP_SERVICE</a> &amp;&amp;
<a name="l00880"></a>00880         selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> != <a class="code" href="ccnd__internal__client_8c.html#acd6be347ddcb8be409557b4b0dcf5d94">OP_ADJACENCY</a> &amp;&amp;
<a name="l00881"></a>00881         info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#af8e2d2c628b4b7bdb82de9edf8f91042">prefix_comps</a> != info-&gt;<a class="code" href="structccn__upcall__info.html#a03ad6fed84681d245643cbe9019db015">matched_comps</a> + morecomps)
<a name="l00882"></a>00882         <span class="keywordflow">goto</span> Bail;
<a name="l00883"></a>00883     <span class="keywordflow">if</span> (morecomps == 1) {
<a name="l00884"></a>00884         res = <a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>,
<a name="l00885"></a>00885                                 info-&gt;<a class="code" href="structccn__upcall__info.html#a03ad6fed84681d245643cbe9019db015">matched_comps</a>,
<a name="l00886"></a>00886                                 &amp;final_comp, &amp;final_size);
<a name="l00887"></a>00887         <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00888"></a>00888             <span class="keywordflow">goto</span> Bail;
<a name="l00889"></a>00889     }
<a name="l00890"></a>00890     <span class="keywordflow">if</span> ((selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> &amp; <a class="code" href="ccn__traverse_8c.html#a9b5ffa374de63b291650d975448a17d8">MUST_VERIFY</a>) != 0) {
<a name="l00891"></a>00891         <span class="keyword">struct </span><a class="code" href="structccn__parsed___content_object.html">ccn_parsed_ContentObject</a> pco = {0};
<a name="l00892"></a>00892         <span class="comment">// XXX - probably should check for message origin BEFORE verify</span>
<a name="l00893"></a>00893         res = <a class="code" href="ccn_8h.html#a464e10bcdb62aa8821df3ce27eb8c5aa">ccn_parse_ContentObject</a>(final_comp, final_size, &amp;pco, NULL);
<a name="l00894"></a>00894         <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00895"></a>00895             <a class="code" href="ccnd__msg_8c.html#ad401ad085e447112e5916594874b566e" title="Produce a ccnd debug trace entry.">ccnd_debug_ccnb</a>(ccnd, __LINE__, <span class="stringliteral">&quot;co_parse_failed&quot;</span>, NULL,
<a name="l00896"></a>00896                             info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00897"></a>00897             <span class="keywordflow">goto</span> Bail;
<a name="l00898"></a>00898         }
<a name="l00899"></a>00899         res = <a class="code" href="ccn_8h.html#a0afdee72d2bb592b031256d72ea7607c" title="Verify a ContentObject using the public key from either the object itself or our...">ccn_verify_content</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, final_comp, &amp;pco);
<a name="l00900"></a>00900         <span class="keywordflow">if</span> (res != 0) {
<a name="l00901"></a>00901             <a class="code" href="ccnd__msg_8c.html#ad401ad085e447112e5916594874b566e" title="Produce a ccnd debug trace entry.">ccnd_debug_ccnb</a>(ccnd, __LINE__, <span class="stringliteral">&quot;co_verify_failed&quot;</span>, NULL,
<a name="l00902"></a>00902                             info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>]);
<a name="l00903"></a>00903             <span class="keywordflow">goto</span> Bail;
<a name="l00904"></a>00904         }
<a name="l00905"></a>00905     }
<a name="l00906"></a>00906     sp.<a class="code" href="structccn__signing__params.html#a768c61b9b4e01e677bcd89f6be350367">freshness</a> = 10;
<a name="l00907"></a>00907     <span class="keywordflow">switch</span> (selfp-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> &amp; <a class="code" href="ccnd__internal__client_8c.html#ada4b17f9699213bd7f57614800256ef3">OPER_MASK</a>) {
<a name="l00908"></a>00908         <span class="keywordflow">case</span> <a class="code" href="ccnd__internal__client_8c.html#a01aaa9cdf37bfba6b05e4465abe182c6">OP_PING</a>:
<a name="l00909"></a>00909             reply_body = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00910"></a>00910             sp.<a class="code" href="structccn__signing__params.html#a768c61b9b4e01e677bcd89f6be350367">freshness</a> = (info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#af8e2d2c628b4b7bdb82de9edf8f91042">prefix_comps</a> == info-&gt;<a class="code" href="structccn__upcall__info.html#a03ad6fed84681d245643cbe9019db015">matched_comps</a>) ? 60 : 5;
<a name="l00911"></a>00911             res = 0;
<a name="l00912"></a>00912             <span class="keywordflow">break</span>;
<a name="l00913"></a>00913         <span class="keywordflow">case</span> <a class="code" href="ccnd__internal__client_8c.html#af61c9112fc18285a11dcdc19bb2eb5d2">OP_NEWFACE</a>:
<a name="l00914"></a>00914             reply_body = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00915"></a>00915             res = <a class="code" href="ccnd_8c.html#a16fa0072e925224d998472801682662f" title="Process a newface request for the ccnd internal client.">ccnd_req_newface</a>(ccnd, final_comp, final_size, reply_body);
<a name="l00916"></a>00916             <span class="keywordflow">break</span>;
<a name="l00917"></a>00917         <span class="keywordflow">case</span> <a class="code" href="ccnd__internal__client_8c.html#a7dd9285eeab9793dfd5033cf7353aa38">OP_DESTROYFACE</a>:
<a name="l00918"></a>00918             reply_body = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00919"></a>00919             res = <a class="code" href="ccnd_8c.html#a90b1f5510cd6766ccfce559d204b9ccd" title="Process a destroyface request for the ccnd internal client.">ccnd_req_destroyface</a>(ccnd, final_comp, final_size, reply_body);
<a name="l00920"></a>00920             <span class="keywordflow">break</span>;
<a name="l00921"></a>00921         <span class="keywordflow">case</span> <a class="code" href="ccnd__internal__client_8c.html#a86a8ce41e90e0acf5186b6846005163a">OP_PREFIXREG</a>:
<a name="l00922"></a>00922             reply_body = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00923"></a>00923             res = <a class="code" href="ccnd_8c.html#aaaf8762e24c13fe59584448616ab93d7" title="Process a prefixreg request for the ccnd internal client.">ccnd_req_prefixreg</a>(ccnd, final_comp, final_size, reply_body);
<a name="l00924"></a>00924             <span class="keywordflow">break</span>;
<a name="l00925"></a>00925         <span class="keywordflow">case</span> <a class="code" href="ccnd__internal__client_8c.html#a7403c633c199ae5fdb285d51c445a466">OP_SELFREG</a>:
<a name="l00926"></a>00926             reply_body = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00927"></a>00927             res = <a class="code" href="ccnd_8c.html#aeb0f8e1589bef387ccf34c5cf3efc33a" title="Process a selfreg request for the ccnd internal client.">ccnd_req_selfreg</a>(ccnd, final_comp, final_size, reply_body);
<a name="l00928"></a>00928             <span class="keywordflow">break</span>;
<a name="l00929"></a>00929         <span class="keywordflow">case</span> <a class="code" href="ccnd__internal__client_8c.html#a00eb5f887f0faa76fae2ab76fa23bf4b">OP_UNREG</a>:
<a name="l00930"></a>00930             reply_body = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00931"></a>00931             res = <a class="code" href="ccnd_8c.html#ad0fb6835ab822706194663c6442d5a83" title="Process an unreg request for the ccnd internal client.">ccnd_req_unreg</a>(ccnd, final_comp, final_size, reply_body);
<a name="l00932"></a>00932             <span class="keywordflow">break</span>;
<a name="l00933"></a>00933         <span class="keywordflow">case</span> <a class="code" href="ccnd__internal__client_8c.html#a5d793d91c901b7b88f493fa05248b573">OP_NOTICE</a>:
<a name="l00934"></a>00934             <a class="code" href="ccnd__internal__client_8c.html#af9d21aae783bf35e49a2ae0a2c146b6b">ccnd_start_notice</a>(ccnd);
<a name="l00935"></a>00935             <span class="keywordflow">goto</span> Bail;
<a name="l00936"></a>00936             <span class="keywordflow">break</span>;
<a name="l00937"></a>00937         <span class="keywordflow">case</span> <a class="code" href="ccnd__internal__client_8c.html#a87c25a5cbf8056c45500ea18f8cc6954">OP_SERVICE</a>:
<a name="l00938"></a>00938             <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#a2d44d3dadcbc86b822fb9bdcc20826ca" title="for local service discovery">service_ccnb</a> == NULL)
<a name="l00939"></a>00939                 ccnd-&gt;<a class="code" href="structccnd__handle.html#a2d44d3dadcbc86b822fb9bdcc20826ca" title="for local service discovery">service_ccnb</a> = <a class="code" href="ccnd__internal__client_8c.html#a2e974a8c43c86e16849682b97ff71a96" title="Creates a key object using the service discovery name profile.">ccnd_init_service_ccnb</a>(ccnd, <a class="code" href="ccnd__private_8h.html#a3a08ea13d0c28d8b4d40f2b5a2ff59ce" title="URIs for prefixes served by the internal client.">CCNDID_LOCAL_URI</a>, 600);
<a name="l00940"></a>00940             <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a2e161e1c17ef110dfa019bc1d560c82c" title="Test for a match between a ContentObject and an Interest.">ccn_content_matches_interest</a>(
<a name="l00941"></a>00941                     ccnd-&gt;<a class="code" href="structccnd__handle.html#a2d44d3dadcbc86b822fb9bdcc20826ca" title="for local service discovery">service_ccnb</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l00942"></a>00942                     ccnd-&gt;<a class="code" href="structccnd__handle.html#a2d44d3dadcbc86b822fb9bdcc20826ca" title="for local service discovery">service_ccnb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l00943"></a>00943                     1,
<a name="l00944"></a>00944                     NULL,
<a name="l00945"></a>00945                     info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>,
<a name="l00946"></a>00946                     info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>],
<a name="l00947"></a>00947                     info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>
<a name="l00948"></a>00948                 )) {
<a name="l00949"></a>00949                 <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, ccnd-&gt;<a class="code" href="structccnd__handle.html#a2d44d3dadcbc86b822fb9bdcc20826ca" title="for local service discovery">service_ccnb</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l00950"></a>00950                                  ccnd-&gt;<a class="code" href="structccnd__handle.html#a2d44d3dadcbc86b822fb9bdcc20826ca" title="for local service discovery">service_ccnb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00951"></a>00951                 res = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l00952"></a>00952                 <span class="keywordflow">goto</span> Finish;
<a name="l00953"></a>00953             }
<a name="l00954"></a>00954             <span class="comment">// XXX this needs refactoring.</span>
<a name="l00955"></a>00955             <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#abd6d813e2701a10266848476ec0f920d" title="for neighbor service discovery">neighbor_ccnb</a> == NULL)
<a name="l00956"></a>00956                 ccnd-&gt;<a class="code" href="structccnd__handle.html#abd6d813e2701a10266848476ec0f920d" title="for neighbor service discovery">neighbor_ccnb</a> = <a class="code" href="ccnd__internal__client_8c.html#a2e974a8c43c86e16849682b97ff71a96" title="Creates a key object using the service discovery name profile.">ccnd_init_service_ccnb</a>(ccnd, <a class="code" href="ccnd__private_8h.html#a86068d2f93ccfc7b26669ac91b098a29">CCNDID_NEIGHBOR_URI</a>, 5);
<a name="l00957"></a>00957             <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a2e161e1c17ef110dfa019bc1d560c82c" title="Test for a match between a ContentObject and an Interest.">ccn_content_matches_interest</a>(
<a name="l00958"></a>00958                     ccnd-&gt;<a class="code" href="structccnd__handle.html#abd6d813e2701a10266848476ec0f920d" title="for neighbor service discovery">neighbor_ccnb</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l00959"></a>00959                     ccnd-&gt;<a class="code" href="structccnd__handle.html#abd6d813e2701a10266848476ec0f920d" title="for neighbor service discovery">neighbor_ccnb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l00960"></a>00960                     1,
<a name="l00961"></a>00961                     NULL,
<a name="l00962"></a>00962                     info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>,
<a name="l00963"></a>00963                     info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>],
<a name="l00964"></a>00964                     info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>
<a name="l00965"></a>00965                 )) {
<a name="l00966"></a>00966                 <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, ccnd-&gt;<a class="code" href="structccnd__handle.html#abd6d813e2701a10266848476ec0f920d" title="for neighbor service discovery">neighbor_ccnb</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l00967"></a>00967                                  ccnd-&gt;<a class="code" href="structccnd__handle.html#abd6d813e2701a10266848476ec0f920d" title="for neighbor service discovery">neighbor_ccnb</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00968"></a>00968                 res = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l00969"></a>00969                 <span class="keywordflow">goto</span> Finish;
<a name="l00970"></a>00970             }
<a name="l00971"></a>00971             <span class="keywordflow">goto</span> Bail;
<a name="l00972"></a>00972             <span class="keywordflow">break</span>;
<a name="l00973"></a>00973         <span class="keywordflow">case</span> <a class="code" href="ccnd__internal__client_8c.html#acd6be347ddcb8be409557b4b0dcf5d94">OP_ADJACENCY</a>:
<a name="l00974"></a>00974             <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#af8e2d2c628b4b7bdb82de9edf8f91042">prefix_comps</a> &gt;= 2 &amp;&amp; (info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#a0c535d59cbe268b169381219513d54c4">answerfrom</a> &amp; <a class="code" href="ccn_8h.html#a8e4feae026026e2ccda69564c64e75f8">CCN_AOK_CS</a>) != 0) {
<a name="l00975"></a>00975                 res = <a class="code" href="ccnd__internal__client_8c.html#a8e0357e8a8c506f01370b27f9d5e0021" title="Answer an adjacency guid request from any face, based on the guid in the name.">ccnd_answer_by_guid</a>(ccnd, info);
<a name="l00976"></a>00976                 <span class="keywordflow">if</span> (res == <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>)
<a name="l00977"></a>00977                     <span class="keywordflow">goto</span> Finish;
<a name="l00978"></a>00978             }
<a name="l00979"></a>00979             face = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, ccnd-&gt;<a class="code" href="structccnd__handle.html#a80709386126dd21a3539617415d549b0" title="for self_reg internal client">interest_faceid</a>);
<a name="l00980"></a>00980             <span class="keywordflow">if</span> (face == NULL)
<a name="l00981"></a>00981                 <span class="keywordflow">goto</span> Bail;
<a name="l00982"></a>00982             <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#af8e2d2c628b4b7bdb82de9edf8f91042">prefix_comps</a> == 1 &amp;&amp; face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> == NULL) {
<a name="l00983"></a>00983                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *lo = NULL;
<a name="l00984"></a>00984                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *hi = NULL;
<a name="l00985"></a>00985                 <span class="keywordtype">int</span> size = 0;
<a name="l00986"></a>00986                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> mb[6] = <span class="stringliteral">&quot;\xC1.M.G\x00&quot;</span>;
<a name="l00987"></a>00987                 
<a name="l00988"></a>00988                 size = <a class="code" href="ccnd__internal__client_8c.html#a46fc7020caa23d44bb66cf0175cde4ca" title="Isolate the lower and upper bounds for the guid component from Exclude.">extract_bounds</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>, info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>, &amp;lo, &amp;hi);
<a name="l00989"></a>00989                 <span class="keywordflow">if</span> (size &gt; (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(mb) &amp;&amp;
<a name="l00990"></a>00990                     0 == memcmp(mb, lo, <span class="keyword">sizeof</span>(mb)) &amp;&amp;
<a name="l00991"></a>00991                     0 == memcmp(mb, hi, <span class="keyword">sizeof</span>(mb))) {
<a name="l00992"></a>00992                     size -= <span class="keyword">sizeof</span>(mb);
<a name="l00993"></a>00993                     lo += <span class="keyword">sizeof</span>(mb);
<a name="l00994"></a>00994                     hi += <span class="keyword">sizeof</span>(mb);
<a name="l00995"></a>00995                     <span class="comment">// XXX - we may want to be selective about proceeding</span>
<a name="l00996"></a>00996                     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; <a class="code" href="ccnd__internal__client_8c.html#a34846ec88e326ca9e5c469b0fd806bc7">ADJ_SOL_SENT</a>) != 0) {
<a name="l00997"></a>00997                         <span class="comment">/* The solicitations crossed in the mail. Arbitrate. */</span>
<a name="l00998"></a>00998                         <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> != NULL &amp;&amp; size &gt;= face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a>[0] &amp;&amp;
<a name="l00999"></a>00999                             memcmp(lo, face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> + 1, face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a>[0]) &gt; 0) {
<a name="l01000"></a>01000                             <a class="code" href="ccnd_8c.html#a77f6fcf336938985eafd10fe085ad0ce" title="Forget the guid associated with a face.">ccnd_forget_face_guid</a>(ccnd, face);
<a name="l01001"></a>01001                             <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, 0, <a class="code" href="ccnd__internal__client_8c.html#a34846ec88e326ca9e5c469b0fd806bc7">ADJ_SOL_SENT</a>);
<a name="l01002"></a>01002                         }
<a name="l01003"></a>01003                     }
<a name="l01004"></a>01004                     <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#ae7439449fa73e7b63a43ac38eac5095c">ADJ_SOL_RECV</a>, <a class="code" href="ccnd__internal__client_8c.html#aa85b9730b33d5be316e5254999d64e5b">ADJ_TIMEDWAIT</a>);
<a name="l01005"></a>01005                     <a class="code" href="ccnd_8c.html#ad9f0ce2aee2fd816d8508717df1976b5" title="Generate a new guid for a face.">ccnd_generate_face_guid</a>(ccnd, face, size, lo, hi);
<a name="l01006"></a>01006                     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#af71f77c720f57c460e21908e709b1d4f" title="guid name for channel, shared w/ peers">guid</a> != NULL) {
<a name="l01007"></a>01007                         <a class="code" href="ccnd__internal__client_8c.html#aadecfbdfe316a850a93580c4499ebc9c" title="Express an interest to pull adjacency information from the other side.">ccnd_adjacency_offer_or_commit_req</a>(ccnd, face);
<a name="l01008"></a>01008                         res = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l01009"></a>01009                         <span class="keywordflow">goto</span> Finish;
<a name="l01010"></a>01010                     }
<a name="l01011"></a>01011                 }
<a name="l01012"></a>01012             }
<a name="l01013"></a>01013             <a class="code" href="ccnd__internal__client_8c.html#ac8cd07d90678a93a68ad2cb245adf687" title="Determine whether an offer matches up with our solicitation.">check_offer_matches_my_solicit</a>(ccnd, face, info);
<a name="l01014"></a>01014             <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a> == NULL)
<a name="l01015"></a>01015                 <a class="code" href="ccnd__internal__client_8c.html#a7208433d97c817cb153e44cf7cd26841" title="Create the adjacency content object for our endpoint of the face.">ccnd_init_face_guid_cob</a>(ccnd, face);
<a name="l01016"></a>01016             <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a> != NULL &amp;&amp;
<a name="l01017"></a>01017                 <a class="code" href="ccn_8h.html#a2e161e1c17ef110dfa019bc1d560c82c" title="Test for a match between a ContentObject and an Interest.">ccn_content_matches_interest</a>(face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l01018"></a>01018                                              face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>,
<a name="l01019"></a>01019                                              1,
<a name="l01020"></a>01020                                              NULL,
<a name="l01021"></a>01021                                              info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a>,
<a name="l01022"></a>01022                                              info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9ae3500edfbd06a2be152e0ef8fcc64328">CCN_PI_E</a>],
<a name="l01023"></a>01023                                              info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>
<a name="l01024"></a>01024                                              )) {
<a name="l01025"></a>01025                 <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#af8e2d2c628b4b7bdb82de9edf8f91042">prefix_comps</a> == 3)
<a name="l01026"></a>01026                     <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#a85aaca3a09dc18b82ac76353f5ba5e9c">ADJ_CRQ_RECV</a>, 0);
<a name="l01027"></a>01027                 <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#afc9a19612aee413b9cfc53d9af752bcc">ADJ_DAT_RECV</a> | <a class="code" href="ccnd__internal__client_8c.html#abd0487488ae47a4ae7497ca20f0c9aba">ADJ_OFR_RECV</a>)) != 0) {
<a name="l01028"></a>01028                     <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>,
<a name="l01029"></a>01029                             face-&gt;<a class="code" href="structface.html#a4ad449dfa7e2b19eedc80151e9ee2db1" title="content object publishing face guid">guid_cob</a>-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);                    
<a name="l01030"></a>01030                     <a class="code" href="ccnd__internal__client_8c.html#a1788ad591829270a6f78de01ee13ee7d">adjstate_change</a>(ccnd, face, <a class="code" href="ccnd__internal__client_8c.html#a14825114770d32358ba3728d4e351bbe">ADJ_DAT_SENT</a>, 0);
<a name="l01031"></a>01031                     <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a6e0089b6f4f4a6d75995ec2431c3a097" title="state of adjacency negotiotiation">adjstate</a> &amp; (<a class="code" href="ccnd__internal__client_8c.html#afc9a19612aee413b9cfc53d9af752bcc">ADJ_DAT_RECV</a>)) == 0)
<a name="l01032"></a>01032                         <a class="code" href="ccnd__internal__client_8c.html#aadecfbdfe316a850a93580c4499ebc9c" title="Express an interest to pull adjacency information from the other side.">ccnd_adjacency_offer_or_commit_req</a>(ccnd, face);
<a name="l01033"></a>01033                 }
<a name="l01034"></a>01034                 <a class="code" href="ccnd__internal__client_8c.html#ac13ee3828f4674ea216d0d84574bc7dc" title="Register the adjacency prefix with the given forwarding flags.">ccnd_register_adjacency</a>(ccnd, face,
<a name="l01035"></a>01035                       <a class="code" href="reg__mgmt_8h.html#a38f4b34f7297b60fd82b57a6ce62d44f">CCN_FORW_CHILD_INHERIT</a> | <a class="code" href="reg__mgmt_8h.html#ae0ad3c46c8762dc3117420b77af96249" title="Refer to doc/technical/Registration.txt for the meaning of these flags.">CCN_FORW_ACTIVE</a>);
<a name="l01036"></a>01036                 res = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l01037"></a>01037                 <span class="keywordflow">goto</span> Finish;
<a name="l01038"></a>01038             }
<a name="l01039"></a>01039             <span class="keywordflow">goto</span> Bail;
<a name="l01040"></a>01040         <span class="keywordflow">default</span>:
<a name="l01041"></a>01041             <span class="keywordflow">goto</span> Bail;
<a name="l01042"></a>01042     }
<a name="l01043"></a>01043     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01044"></a>01044         <span class="keywordflow">goto</span> Bail;
<a name="l01045"></a>01045     <span class="keywordflow">if</span> (res == <a class="code" href="ccn_8h.html#a5ac452b850189ae724c4ff89ae81c702a277adabdd800cc480a6f9a09344d5a7f">CCN_CONTENT_NACK</a>)
<a name="l01046"></a>01046         sp.<a class="code" href="structccn__signing__params.html#a4816531af13fcf3981ea44bf2d4c9b2f">type</a> = res;
<a name="l01047"></a>01047     msg = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01048"></a>01048     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01049"></a>01049     start = info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#aa9895008888641d588d8f2ba53e9a46a">offset</a>[<a class="code" href="ccn_8h.html#af757316233f18d2b2252600bbd780dd9aec6eb389501f45e87378621c413261e2">CCN_PI_B_Name</a>];
<a name="l01050"></a>01050     end = info-&gt;<a class="code" href="structccn__upcall__info.html#a685d7846f37c9dea4dcda981f0267906">interest_comps</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[info-&gt;<a class="code" href="structccn__upcall__info.html#a1a8d0a58199c0624d003962d298982d5">pi</a>-&gt;<a class="code" href="structccn__parsed__interest.html#af8e2d2c628b4b7bdb82de9edf8f91042">prefix_comps</a>];
<a name="l01051"></a>01051     <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(name, info-&gt;<a class="code" href="structccn__upcall__info.html#ac8c5f48f32ed349e401f697e1e72b43c">interest_ccnb</a> + start, end - start);
<a name="l01052"></a>01052     <a class="code" href="ccn_8h.html#ac8fba19d429bb106de10a008142882aa" title="Append a CCN_CLOSE.">ccn_charbuf_append_closer</a>(name);
<a name="l01053"></a>01053     res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, msg, name, &amp;sp,
<a name="l01054"></a>01054                            reply_body-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, reply_body-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01055"></a>01055     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01056"></a>01056         <span class="keywordflow">goto</span> Bail;
<a name="l01057"></a>01057     <span class="keywordflow">if</span> ((ccnd-&gt;<a class="code" href="structccnd__handle.html#af1f782a44b7c5da14c5608974cc7677c" title="For controlling debug output.">debug</a> &amp; 128) != 0)
<a name="l01058"></a>01058         <a class="code" href="ccnd__msg_8c.html#ad401ad085e447112e5916594874b566e" title="Produce a ccnd debug trace entry.">ccnd_debug_ccnb</a>(ccnd, __LINE__, <span class="stringliteral">&quot;ccnd_answer_req_response&quot;</span>, NULL,
<a name="l01059"></a>01059                         msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01060"></a>01060     res = <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01061"></a>01061     <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01062"></a>01062         <span class="keywordflow">goto</span> Bail;
<a name="l01063"></a>01063     <span class="keywordflow">if</span> (CCND_TEST_100137)
<a name="l01064"></a>01064         <a class="code" href="ccn_8h.html#ac71f5c8727443c13afb11cf471f5f8fc">ccn_put</a>(info-&gt;<a class="code" href="structccn__upcall__info.html#abdc317226974c6e28e21f46ce5348708" title="The ccn library handle.">h</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01065"></a>01065     res = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca35e0232348739cde04ba6355c4395001" title="upcall claims to consume interest">CCN_UPCALL_RESULT_INTEREST_CONSUMED</a>;
<a name="l01066"></a>01066     <span class="keywordflow">goto</span> Finish;
<a name="l01067"></a>01067 Bail:
<a name="l01068"></a>01068     res = <a class="code" href="ccn_8h.html#ac4cc3fdb432fd23cdc0c5642276b0ddca66af9fd66092212c05d898ca20d3c6f2" title="upcall detected an error">CCN_UPCALL_RESULT_ERR</a>;
<a name="l01069"></a>01069 Finish:
<a name="l01070"></a>01070     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;msg);
<a name="l01071"></a>01071     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l01072"></a>01072     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;keylocator);
<a name="l01073"></a>01073     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;reply_body);
<a name="l01074"></a>01074     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;signed_info);
<a name="l01075"></a>01075     <span class="keywordflow">return</span>(res);
<a name="l01076"></a>01076 }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01079"></a><a class="code" href="ccnd__internal__client_8c.html#a88ed95941a92a0e98de872c855de44c0">01079</a> <a class="code" href="ccnd__internal__client_8c.html#a88ed95941a92a0e98de872c855de44c0">ccnd_internal_client_refresh</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l01080"></a>01080                <span class="keywordtype">void</span> *clienth,
<a name="l01081"></a>01081                <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l01082"></a>01082                <span class="keywordtype">int</span> flags)
<a name="l01083"></a>01083 {
<a name="l01084"></a>01084     <span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd = clienth;
<a name="l01085"></a>01085     <span class="keywordtype">int</span> microsec = 0;
<a name="l01086"></a>01086     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) == 0 &amp;&amp;
<a name="l01087"></a>01087           ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a> != NULL &amp;&amp;
<a name="l01088"></a>01088           ccnd-&gt;<a class="code" href="structccnd__handle.html#a858f9215865200c123eca8c3a1828b6b">internal_client_refresh</a> == ev) {
<a name="l01089"></a>01089         microsec = <a class="code" href="ccn__private_8h.html#aea1c520347cd3a42b97611e84635dcb7" title="Process any scheduled operations that are due.">ccn_process_scheduled_operations</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>);
<a name="l01090"></a>01090         <span class="keywordflow">if</span> (microsec &gt; ev-&gt;<a class="code" href="structccn__scheduled__event.html#a22f5ee0bc7a266aa2d35ad482cb8c4c3">evint</a>)
<a name="l01091"></a>01091             microsec = ev-&gt;<a class="code" href="structccn__scheduled__event.html#a22f5ee0bc7a266aa2d35ad482cb8c4c3">evint</a>;
<a name="l01092"></a>01092     }
<a name="l01093"></a>01093     <span class="keywordflow">if</span> (microsec &lt;= 0 &amp;&amp; ccnd-&gt;<a class="code" href="structccnd__handle.html#a858f9215865200c123eca8c3a1828b6b">internal_client_refresh</a> == ev)
<a name="l01094"></a>01094         ccnd-&gt;<a class="code" href="structccnd__handle.html#a858f9215865200c123eca8c3a1828b6b">internal_client_refresh</a> = NULL;
<a name="l01095"></a>01095     <span class="keywordflow">return</span>(microsec);
<a name="l01096"></a>01096 }
<a name="l01097"></a>01097 
<a name="l01098"></a><a class="code" href="ccnd__internal__client_8c.html#a82f0ee57c1a9bbc80af1c7c482d460c2">01098</a> <span class="preprocessor">#define CCND_ID_TEMPL &quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>
<a name="l01099"></a>01099 <span class="preprocessor"></span>
<a name="l01100"></a>01100 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01101"></a><a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">01101</a> <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keyword">const</span> <span class="keywordtype">char</span> *uri,
<a name="l01102"></a>01102                 <a class="code" href="ccn_8h.html#a9570a786d534c3eb0343de466857f11f" title="ccn_handler This is the procedure type for the closure&amp;#39;s implementation.">ccn_handler</a> p, intptr_t intdata)
<a name="l01103"></a>01103 {
<a name="l01104"></a>01104     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name;
<a name="l01105"></a>01105     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *uri_modified = NULL;
<a name="l01106"></a>01106     <span class="keyword">struct </span><a class="code" href="structccn__closure.html" title="Handle for upcalls that allow clients receive notifications of incoming interests...">ccn_closure</a> *closure;
<a name="l01107"></a>01107     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *comps;
<a name="l01108"></a>01108     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *comp;
<a name="l01109"></a>01109     <span class="keywordtype">size_t</span> comp_size;
<a name="l01110"></a>01110     <span class="keywordtype">size_t</span> offset;
<a name="l01111"></a>01111     <span class="keywordtype">int</span> reg_wanted = 1;
<a name="l01112"></a>01112     
<a name="l01113"></a>01113     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01114"></a>01114     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, uri);
<a name="l01115"></a>01115     comps = <a class="code" href="indexbuf_8h.html#a00ef00b3c7cbd2122bcdad019bd285c6" title="Create a new indexbuf.">ccn_indexbuf_create</a>();
<a name="l01116"></a>01116     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a75efe309adf727b49a9afe58fed4b483" title="Find Component boundaries in a ccnb-encoded Name.">ccn_name_split</a>(name, comps) &lt; 0)
<a name="l01117"></a>01117         abort();
<a name="l01118"></a>01118     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a70c13909ea45ffb1069916d7a512fdda" title="Extract a pointer to and size of component at given index i.">ccn_name_comp_get</a>(name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, comps, 1, &amp;comp, &amp;comp_size) &gt;= 0) {
<a name="l01119"></a>01119         <span class="keywordflow">if</span> (comp_size == 32 &amp;&amp; 0 == memcmp(comp, <a class="code" href="ccnd__internal__client_8c.html#a82f0ee57c1a9bbc80af1c7c482d460c2">CCND_ID_TEMPL</a>, 32)) {
<a name="l01120"></a>01120             <span class="comment">/* Replace placeholder with our ccnd_id */</span>
<a name="l01121"></a>01121             offset = comp - name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>;
<a name="l01122"></a>01122             memcpy(name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + offset, ccnd-&gt;<a class="code" href="structccnd__handle.html#a935a4fbf6e79b677d425d49661326e7e" title="sha256 digest of our public key">ccnd_id</a>, 32);
<a name="l01123"></a>01123             uri_modified = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01124"></a>01124             <a class="code" href="uri_8h.html#a46512a74f8d78b3e01fbc115f652ae8d" title="This appends to c a URI representation of the ccnb-encoded Name element passed in...">ccn_uri_append</a>(uri_modified, name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1);
<a name="l01125"></a>01125             uri = (<span class="keywordtype">char</span> *)uri_modified-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>;
<a name="l01126"></a>01126             reg_wanted = 0;
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128     }
<a name="l01129"></a>01129     closure = calloc(1, <span class="keyword">sizeof</span>(*closure));
<a name="l01130"></a>01130     closure-&gt;<a class="code" href="structccn__closure.html#a48dca74271023e0caf287ad31dd1e66c" title="client-supplied handler">p</a> = p;
<a name="l01131"></a>01131     closure-&gt;<a class="code" href="structccn__closure.html#a7173ea9b9dde3c4bbded120b90ae788c" title="for client use">data</a> = ccnd;
<a name="l01132"></a>01132     closure-&gt;<a class="code" href="structccn__closure.html#a25a1e0591079ef386d0708a81f14b711" title="for client use">intdata</a> = intdata;
<a name="l01133"></a>01133     <span class="comment">/* Register explicitly if needed or requested */</span>
<a name="l01134"></a>01134     <span class="keywordflow">if</span> (reg_wanted)
<a name="l01135"></a>01135         <a class="code" href="ccnd_8c.html#a6a4a51f315cdeac27bdee3546f9d88f0" title="Register a prefix, expressed in the form of a URI.">ccnd_reg_uri</a>(ccnd, uri,
<a name="l01136"></a>01136                      0, <span class="comment">/* special faceid for internal client */</span>
<a name="l01137"></a>01137                      <a class="code" href="reg__mgmt_8h.html#a38f4b34f7297b60fd82b57a6ce62d44f">CCN_FORW_CHILD_INHERIT</a> | <a class="code" href="reg__mgmt_8h.html#ae0ad3c46c8762dc3117420b77af96249" title="Refer to doc/technical/Registration.txt for the meaning of these flags.">CCN_FORW_ACTIVE</a>,
<a name="l01138"></a>01138                      0x7FFFFFFF);
<a name="l01139"></a>01139     <a class="code" href="ccn_8h.html#a9193ff0e42816aea703225a374d5532d" title="Register to receive interests on a prefix.">ccn_set_interest_filter</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>, name, closure);
<a name="l01140"></a>01140     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l01141"></a>01141     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;uri_modified);
<a name="l01142"></a>01142     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;comps);
<a name="l01143"></a>01143 }
<a name="l01144"></a>01144 <span class="comment"></span>
<a name="l01145"></a>01145 <span class="comment">/**</span>
<a name="l01146"></a>01146 <span class="comment"> * Make a forwarding table entry for ccnx:/ccnx/CCNDID</span>
<a name="l01147"></a>01147 <span class="comment"> *</span>
<a name="l01148"></a>01148 <span class="comment"> * This one entry handles most of the namespace served by the</span>
<a name="l01149"></a>01149 <span class="comment"> * ccnd internal client.</span>
<a name="l01150"></a>01150 <span class="comment"> */</span>
<a name="l01151"></a>01151 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01152"></a><a class="code" href="ccnd__internal__client_8c.html#abebd1396d6be057220f1cb2c62a59de6">01152</a> <a class="code" href="ccnd__internal__client_8c.html#abebd1396d6be057220f1cb2c62a59de6" title="Make a forwarding table entry for ccnx:/ccnx/CCNDID.">ccnd_reg_ccnx_ccndid</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd)
<a name="l01153"></a>01153 {
<a name="l01154"></a>01154     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name;
<a name="l01155"></a>01155     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *uri;
<a name="l01156"></a>01156     
<a name="l01157"></a>01157     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01158"></a>01158     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;ccnx:/ccnx&quot;</span>);
<a name="l01159"></a>01159     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, ccnd-&gt;<a class="code" href="structccnd__handle.html#a935a4fbf6e79b677d425d49661326e7e" title="sha256 digest of our public key">ccnd_id</a>, 32);
<a name="l01160"></a>01160     uri = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01161"></a>01161     <a class="code" href="uri_8h.html#a46512a74f8d78b3e01fbc115f652ae8d" title="This appends to c a URI representation of the ccnb-encoded Name element passed in...">ccn_uri_append</a>(uri, name-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, name-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1);
<a name="l01162"></a>01162     <a class="code" href="ccnd_8c.html#a6a4a51f315cdeac27bdee3546f9d88f0" title="Register a prefix, expressed in the form of a URI.">ccnd_reg_uri</a>(ccnd, <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uri),
<a name="l01163"></a>01163                  0, <span class="comment">/* special faceid for internal client */</span>
<a name="l01164"></a>01164                  (<a class="code" href="reg__mgmt_8h.html#a38f4b34f7297b60fd82b57a6ce62d44f">CCN_FORW_CHILD_INHERIT</a> |
<a name="l01165"></a>01165                   <a class="code" href="reg__mgmt_8h.html#ae0ad3c46c8762dc3117420b77af96249" title="Refer to doc/technical/Registration.txt for the meaning of these flags.">CCN_FORW_ACTIVE</a>        |
<a name="l01166"></a>01166                   <a class="code" href="reg__mgmt_8h.html#afe9f37c2d75eddceaccc2784e701c9c6">CCN_FORW_CAPTURE</a>       |
<a name="l01167"></a>01167                   <a class="code" href="reg__mgmt_8h.html#a88a689784bcd059a5984fa3e703075da">CCN_FORW_ADVERTISE</a>     ),
<a name="l01168"></a>01168                  0x7FFFFFFF);
<a name="l01169"></a>01169     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l01170"></a>01170     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;uri);
<a name="l01171"></a>01171 }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173 <span class="preprocessor">#ifndef CCN_PATH_VAR_TMP</span>
<a name="l01174"></a><a class="code" href="ccnd__internal__client_8c.html#a17b0a2fb7c2ec9eb5b8dc1f60a04d9be">01174</a> <span class="preprocessor"></span><span class="preprocessor">#define CCN_PATH_VAR_TMP &quot;/var/tmp&quot;</span>
<a name="l01175"></a>01175 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01176"></a>01176 <span class="preprocessor"></span>
<a name="l01177"></a>01177 <span class="comment">/*</span>
<a name="l01178"></a>01178 <span class="comment"> * This is used to shroud the contents of the keystore, which mainly serves</span>
<a name="l01179"></a>01179 <span class="comment"> * to add integrity checking and defense against accidental misuse.</span>
<a name="l01180"></a>01180 <span class="comment"> * The file permissions serve for restricting access to the private keys.</span>
<a name="l01181"></a>01181 <span class="comment"> */</span>
<a name="l01182"></a>01182 <span class="preprocessor">#ifndef CCND_KEYSTORE_PASS</span>
<a name="l01183"></a><a class="code" href="ccnd__internal__client_8c.html#ad185d9b422fcdd67950b01289747a6d2">01183</a> <span class="preprocessor"></span><span class="preprocessor">#define CCND_KEYSTORE_PASS &quot;\010\043\103\375\327\237\152\351\155&quot;</span>
<a name="l01184"></a>01184 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01185"></a>01185 <span class="preprocessor"></span>
<a name="l01186"></a>01186 <span class="keywordtype">int</span>
<a name="l01187"></a><a class="code" href="ccnd__private_8h.html#ab11d80073a66bc92842ab9a158254b8c">01187</a> <a class="code" href="ccnd__internal__client_8c.html#a951cf92331308d6ba8b12ba1139de139">ccnd_init_internal_keystore</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd)
<a name="l01188"></a>01188 {
<a name="l01189"></a>01189     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *temp = NULL;
<a name="l01190"></a>01190     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *cmd = NULL;
<a name="l01191"></a>01191     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *culprit = NULL;
<a name="l01192"></a>01192     <span class="keyword">struct </span>stat statbuf;
<a name="l01193"></a>01193     <span class="keyword">const</span> <span class="keywordtype">char</span> *dir = NULL;
<a name="l01194"></a>01194     <span class="keywordtype">int</span> res = -1;
<a name="l01195"></a>01195     <span class="keywordtype">char</span> *keystore_path = NULL;
<a name="l01196"></a>01196     <span class="keyword">struct </span><a class="code" href="structccn__signing__params.html" title="Parameters for creating signed content objects.">ccn_signing_params</a> sp = <a class="code" href="ccn_8h.html#a4ff046ac820ac0f2ef6acb912a03b328">CCN_SIGNING_PARAMS_INIT</a>;
<a name="l01197"></a>01197     
<a name="l01198"></a>01198     <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a> == NULL)
<a name="l01199"></a>01199         <span class="keywordflow">return</span>(-1);
<a name="l01200"></a>01200     temp = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01201"></a>01201     cmd = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01202"></a>01202     dir = getenv(<span class="stringliteral">&quot;CCND_KEYSTORE_DIRECTORY&quot;</span>);
<a name="l01203"></a>01203     <span class="keywordflow">if</span> (dir != NULL &amp;&amp; dir[0] == <span class="charliteral">&#39;/&#39;</span>)
<a name="l01204"></a>01204         <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(temp, <span class="stringliteral">&quot;%s/&quot;</span>, dir);
<a name="l01205"></a>01205     <span class="keywordflow">else</span>
<a name="l01206"></a>01206         <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(temp, <a class="code" href="ccnd__internal__client_8c.html#a17b0a2fb7c2ec9eb5b8dc1f60a04d9be">CCN_PATH_VAR_TMP</a> <span class="stringliteral">&quot;/.ccnx-user%d/&quot;</span>, (<span class="keywordtype">int</span>)geteuid());
<a name="l01207"></a>01207     res = stat(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(temp), &amp;statbuf);
<a name="l01208"></a>01208     <span class="keywordflow">if</span> (res == -1) {
<a name="l01209"></a>01209         <span class="keywordflow">if</span> (errno == ENOENT)
<a name="l01210"></a>01210             res = mkdir(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(temp), 0700);
<a name="l01211"></a>01211         <span class="keywordflow">if</span> (res != 0) {
<a name="l01212"></a>01212             culprit = temp;
<a name="l01213"></a>01213             <span class="keywordflow">goto</span> Finish;
<a name="l01214"></a>01214         }
<a name="l01215"></a>01215     }
<a name="l01216"></a>01216     <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(temp, <span class="stringliteral">&quot;.ccnd_keystore_%s&quot;</span>, ccnd-&gt;<a class="code" href="structccnd__handle.html#a9b1361588d12a2fe1763702be5fa156e" title="&amp;quot;main&amp;quot; port number">portstr</a>);
<a name="l01217"></a>01217     keystore_path = strdup(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(temp));
<a name="l01218"></a>01218     res = stat(keystore_path, &amp;statbuf);
<a name="l01219"></a>01219     <span class="keywordflow">if</span> (res == 0)
<a name="l01220"></a>01220         res = <a class="code" href="ccn_8h.html#a84e164010a78b31d5a4631dc50168f63" title="Load the handle&amp;#39;s default signing key from a keystore.">ccn_load_default_key</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>, keystore_path, <a class="code" href="ccnd__internal__client_8c.html#ad185d9b422fcdd67950b01289747a6d2">CCND_KEYSTORE_PASS</a>);
<a name="l01221"></a>01221     <span class="keywordflow">if</span> (res &gt;= 0)
<a name="l01222"></a>01222         <span class="keywordflow">goto</span> Finish;
<a name="l01223"></a>01223     <span class="comment">/* No stored keystore that we can access; create one. */</span>
<a name="l01224"></a>01224     res = <a class="code" href="keystore_8h.html#aa029bfb8a9ab81c2ff3b89da486d75f0" title="Create a PKCS12 keystore file.">ccn_keystore_file_init</a>(keystore_path, <a class="code" href="ccnd__internal__client_8c.html#ad185d9b422fcdd67950b01289747a6d2">CCND_KEYSTORE_PASS</a>, <span class="stringliteral">&quot;CCND-internal&quot;</span>, 0, 0);
<a name="l01225"></a>01225     <span class="keywordflow">if</span> (res != 0) {
<a name="l01226"></a>01226         culprit = temp;
<a name="l01227"></a>01227         <span class="keywordflow">goto</span> Finish;
<a name="l01228"></a>01228     }
<a name="l01229"></a>01229     res = <a class="code" href="ccn_8h.html#a84e164010a78b31d5a4631dc50168f63" title="Load the handle&amp;#39;s default signing key from a keystore.">ccn_load_default_key</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>, keystore_path, <a class="code" href="ccnd__internal__client_8c.html#ad185d9b422fcdd67950b01289747a6d2">CCND_KEYSTORE_PASS</a>);
<a name="l01230"></a>01230     <span class="keywordflow">if</span> (res != 0)
<a name="l01231"></a>01231         culprit = temp;
<a name="l01232"></a>01232 Finish:
<a name="l01233"></a>01233     <span class="keywordflow">if</span> (culprit != NULL) {
<a name="l01234"></a>01234         <a class="code" href="ccnd__msg_8c.html#ab366c8b24b40d405717b70124e6049be" title="Produce ccnd debug output.">ccnd_msg</a>(ccnd, <span class="stringliteral">&quot;%s: %s:\n&quot;</span>, <a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(culprit), strerror(errno));
<a name="l01235"></a>01235         culprit = NULL;
<a name="l01236"></a>01236     }
<a name="l01237"></a>01237     res = <a class="code" href="ccn_8h.html#a3fad8da4139732b27be40706356ec446" title="This is mostly for use within the library, but may be useful for some clients.">ccn_chk_signing_params</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>, NULL, &amp;sp, NULL, NULL, NULL, NULL);
<a name="l01238"></a>01238     <span class="keywordflow">if</span> (res != 0)
<a name="l01239"></a>01239         abort();
<a name="l01240"></a>01240     memcpy(ccnd-&gt;<a class="code" href="structccnd__handle.html#a935a4fbf6e79b677d425d49661326e7e" title="sha256 digest of our public key">ccnd_id</a>, sp.<a class="code" href="structccn__signing__params.html#a0a03cda1c779bf7856ab985d792681db">pubid</a>, <span class="keyword">sizeof</span>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a935a4fbf6e79b677d425d49661326e7e" title="sha256 digest of our public key">ccnd_id</a>));
<a name="l01241"></a>01241     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;temp);
<a name="l01242"></a>01242     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;cmd);
<a name="l01243"></a>01243     <span class="keywordflow">if</span> (keystore_path != NULL)
<a name="l01244"></a>01244         free(keystore_path);
<a name="l01245"></a>01245     <span class="keywordflow">return</span>(res);
<a name="l01246"></a>01246 }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01249"></a><a class="code" href="ccnd__internal__client_8c.html#a3a88965c76b0275c692681d11e0d3c88">01249</a> <a class="code" href="ccnd__internal__client_8c.html#a3a88965c76b0275c692681d11e0d3c88">post_face_notice</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keywordtype">unsigned</span> faceid)
<a name="l01250"></a>01250 {
<a name="l01251"></a>01251     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = <a class="code" href="ccnd_8c.html#aeccb0edccd5bfbab65ac192403fbe8dc" title="Looks up a face based on its faceid.">ccnd_face_from_faceid</a>(ccnd, faceid);
<a name="l01252"></a>01252     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *msg = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01253"></a>01253     <span class="keywordtype">int</span> res = -1;
<a name="l01254"></a>01254     <span class="keywordtype">int</span> port;
<a name="l01255"></a>01255     <span class="keywordtype">int</span> n;
<a name="l01256"></a>01256     
<a name="l01257"></a>01257     <span class="comment">// XXX - text version for trying out stream stuff - replace with ccnb</span>
<a name="l01258"></a>01258     <span class="keywordflow">if</span> (face == NULL)
<a name="l01259"></a>01259         <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(msg, <span class="stringliteral">&quot;destroyface(%u);\n&quot;</span>, faceid);
<a name="l01260"></a>01260     <span class="keywordflow">else</span> {
<a name="l01261"></a>01261         <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(msg, <span class="stringliteral">&quot;newface(%u, 0x%x&quot;</span>, faceid, face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a>);
<a name="l01262"></a>01262         n = 2;
<a name="l01263"></a>01263         <span class="keywordflow">if</span> (face-&gt;<a class="code" href="structface.html#aaccba8b4dd870f02d6b415a651d2a2c3">addr</a> != NULL &amp;&amp;
<a name="l01264"></a>01264             (face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> &amp; (<a class="code" href="ccnd__private_8h.html#aff5ec7be8423966b46f091d689398c61" title="IPv4.">CCN_FACE_INET</a> | <a class="code" href="ccnd__private_8h.html#a59d255f7198e1f8a01571826694a947a" title="IPv6.">CCN_FACE_INET6</a>)) != 0) {
<a name="l01265"></a>01265             <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(msg, <span class="stringliteral">&quot;, &quot;</span>);
<a name="l01266"></a>01266             n++;
<a name="l01267"></a>01267             port = <a class="code" href="sockaddrutil_8h.html#a8479daa5aff0446d0c9ba9a70597350f" title="Append a printable representation of sa (sans any port info) to the charbuf.">ccn_charbuf_append_sockaddr</a>(msg, face-&gt;<a class="code" href="structface.html#aaccba8b4dd870f02d6b415a651d2a2c3">addr</a>);
<a name="l01268"></a>01268             <span class="keywordflow">if</span> (port &lt; 0)
<a name="l01269"></a>01269                 msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>--;
<a name="l01270"></a>01270             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (port &gt; 0)
<a name="l01271"></a>01271                 <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(msg, <span class="stringliteral">&quot;:%d&quot;</span>, port);
<a name="l01272"></a>01272         }
<a name="l01273"></a>01273         <span class="keywordflow">if</span> ((face-&gt;<a class="code" href="structface.html#a19a6afef7e4e17e1d856082c3d932abe" title="CCN_FACE_* face flags.">flags</a> &amp; <a class="code" href="ccnd__private_8h.html#a0812bb8fb538d1c4cfa366fac505f9a9">CCN_FACE_ADJ</a>) != 0) {
<a name="l01274"></a>01274             <span class="keywordflow">for</span> (; n &lt; 4; n++)
<a name="l01275"></a>01275                 <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(msg, <span class="stringliteral">&quot;, &quot;</span>);
<a name="l01276"></a>01276             <a class="code" href="ccnd__internal__client_8c.html#a89052e5e0cdb2dea9b09601f4e758189" title="Append the URI representation of the adjacency prefix for face to the charbuf cb...">append_adjacency_uri</a>(ccnd, msg, face);
<a name="l01277"></a>01277         }
<a name="l01278"></a>01278         <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(msg, <span class="stringliteral">&quot;);\n&quot;</span>, faceid);
<a name="l01279"></a>01279     }
<a name="l01280"></a>01280     res = <a class="code" href="seqwriter_8h.html#a679b0694a43c699371a3b64340d0f2d5" title="Write some data to a seqwriter.">ccn_seqw_write</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ad4ea25e65cc040d7db4bfabc6d437efa" title="for notices of status changes">notice</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, msg-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l01281"></a>01281     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;msg);
<a name="l01282"></a>01282     <span class="keywordflow">return</span>(res);
<a name="l01283"></a>01283 }
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01286"></a><a class="code" href="ccnd__internal__client_8c.html#a300c996a99ed809ebd1a023e030525d0">01286</a> <a class="code" href="ccnd__internal__client_8c.html#a300c996a99ed809ebd1a023e030525d0">ccnd_notice_push</a>(<span class="keyword">struct</span> ccn_schedule *sched,
<a name="l01287"></a>01287                <span class="keywordtype">void</span> *clienth,
<a name="l01288"></a>01288                <span class="keyword">struct</span> <a class="code" href="structccn__scheduled__event.html">ccn_scheduled_event</a> *ev,
<a name="l01289"></a>01289                <span class="keywordtype">int</span> flags)
<a name="l01290"></a>01290 {
<a name="l01291"></a>01291     <span class="keyword">struct </span><a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd = clienth;
<a name="l01292"></a>01292     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *chface = NULL;
<a name="l01293"></a>01293     <span class="keywordtype">int</span> i = 0;
<a name="l01294"></a>01294     <span class="keywordtype">int</span> j = 0;
<a name="l01295"></a>01295     <span class="keywordtype">int</span> microsec = 0;
<a name="l01296"></a>01296     <span class="keywordtype">int</span> res = 0;
<a name="l01297"></a>01297     
<a name="l01298"></a>01298     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="schedule_8h.html#a705b7a47118864084280c615c0e6a2de">CCN_SCHEDULE_CANCEL</a>) == 0 &amp;&amp;
<a name="l01299"></a>01299             ccnd-&gt;<a class="code" href="structccnd__handle.html#ad4ea25e65cc040d7db4bfabc6d437efa" title="for notices of status changes">notice</a> != NULL &amp;&amp;
<a name="l01300"></a>01300             ccnd-&gt;<a class="code" href="structccnd__handle.html#a4af1b200fef141e2a3c90fae6f0e49ba">notice_push</a> == ev &amp;&amp;
<a name="l01301"></a>01301             ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a> != NULL) {
<a name="l01302"></a>01302         chface = ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a>;
<a name="l01303"></a>01303         <a class="code" href="seqwriter_8h.html#aca5f5c9f5cbc8d992670bb17ded30c45" title="Start a batch of writes.">ccn_seqw_batch_start</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ad4ea25e65cc040d7db4bfabc6d437efa" title="for notices of status changes">notice</a>);
<a name="l01304"></a>01304         <span class="keywordflow">for</span> (i = 0; i &lt; chface-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> &amp;&amp; res != -1; i++)
<a name="l01305"></a>01305             res = <a class="code" href="ccnd__internal__client_8c.html#a3a88965c76b0275c692681d11e0d3c88">post_face_notice</a>(ccnd, chface-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[i]);
<a name="l01306"></a>01306         <a class="code" href="seqwriter_8h.html#a478eecf445a9840ab0cf88c33687e37f" title="End a batch of writes.">ccn_seqw_batch_end</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ad4ea25e65cc040d7db4bfabc6d437efa" title="for notices of status changes">notice</a>);
<a name="l01307"></a>01307         <span class="keywordflow">for</span> (j = 0; i &lt; chface-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a>; i++, j++)
<a name="l01308"></a>01308             chface-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[j] = chface-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[i];
<a name="l01309"></a>01309         chface-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> = j;
<a name="l01310"></a>01310         if (res == -1)
<a name="l01311"></a>01311             microsec = 3000;
<a name="l01312"></a>01312     }
<a name="l01313"></a>01313     <span class="keywordflow">if</span> (microsec &lt;= 0)
<a name="l01314"></a>01314         ccnd-&gt;<a class="code" href="structccnd__handle.html#a4af1b200fef141e2a3c90fae6f0e49ba">notice_push</a> = NULL;
<a name="l01315"></a>01315     <span class="keywordflow">return</span>(microsec);
<a name="l01316"></a>01316 }
<a name="l01317"></a>01317 <span class="comment"></span>
<a name="l01318"></a>01318 <span class="comment">/**</span>
<a name="l01319"></a>01319 <span class="comment"> * Called by ccnd when a face undergoes a substantive status change that</span>
<a name="l01320"></a>01320 <span class="comment"> * should be reported to interested parties.</span>
<a name="l01321"></a>01321 <span class="comment"> *</span>
<a name="l01322"></a>01322 <span class="comment"> * In the destroy case, this is called from the hash table finalizer,</span>
<a name="l01323"></a>01323 <span class="comment"> * so it shouldn&#39;t do much directly.  Inspecting the face is OK, though.</span>
<a name="l01324"></a>01324 <span class="comment"> */</span>
<a name="l01325"></a>01325 <span class="keywordtype">void</span>
<a name="l01326"></a><a class="code" href="ccnd__private_8h.html#ac69995a22b5473564ee7c83ea4189d9f">01326</a> <a class="code" href="ccnd__internal__client_8c.html#a9a8312e047d60e5e17dbe0f248ada546" title="Called by ccnd when a face undergoes a substantive status change that should be reported...">ccnd_face_status_change</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd, <span class="keywordtype">unsigned</span> faceid)
<a name="l01327"></a>01327 {
<a name="l01328"></a>01328     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *chface = ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a>;
<a name="l01329"></a>01329     
<a name="l01330"></a>01330     <span class="keywordflow">if</span> (chface != NULL) {
<a name="l01331"></a>01331         <a class="code" href="indexbuf_8h.html#ac9d75b010bd9231b88c0c812d8d32c07">ccn_indexbuf_set_insert</a>(chface, faceid);
<a name="l01332"></a>01332         <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#a4af1b200fef141e2a3c90fae6f0e49ba">notice_push</a> == NULL)
<a name="l01333"></a>01333             ccnd-&gt;<a class="code" href="structccnd__handle.html#a4af1b200fef141e2a3c90fae6f0e49ba">notice_push</a> = <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a>, 2000,
<a name="l01334"></a>01334                                                    <a class="code" href="ccnd__internal__client_8c.html#a300c996a99ed809ebd1a023e030525d0">ccnd_notice_push</a>,
<a name="l01335"></a>01335                                                    NULL, 0);
<a name="l01336"></a>01336     }
<a name="l01337"></a>01337     <a class="code" href="ccnd__internal__client_8c.html#ae28569a32965b42d7bfb047b9baa00c1" title="Schedule negotiation of a link guid if appropriate.">schedule_adjacency_negotiation</a>(ccnd, faceid);
<a name="l01338"></a>01338 }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01341"></a><a class="code" href="ccnd__internal__client_8c.html#af9d21aae783bf35e49a2ae0a2c146b6b">01341</a> <a class="code" href="ccnd__internal__client_8c.html#af9d21aae783bf35e49a2ae0a2c146b6b">ccnd_start_notice</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd)
<a name="l01342"></a>01342 {
<a name="l01343"></a>01343     <span class="keyword">struct </span>ccn *h = ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>;
<a name="l01344"></a>01344     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = NULL;
<a name="l01345"></a>01345     <span class="keyword">struct </span><a class="code" href="structface.html" title="One of our active faces.">face</a> *<a class="code" href="structface.html" title="One of our active faces.">face</a> = NULL;
<a name="l01346"></a>01346     <span class="keywordtype">int</span> i;
<a name="l01347"></a>01347     
<a name="l01348"></a>01348     <span class="keywordflow">if</span> (h == NULL)
<a name="l01349"></a>01349         <span class="keywordflow">return</span>;
<a name="l01350"></a>01350     <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#ad4ea25e65cc040d7db4bfabc6d437efa" title="for notices of status changes">notice</a> != NULL)
<a name="l01351"></a>01351         <span class="keywordflow">return</span>;
<a name="l01352"></a>01352     <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a> != NULL) {
<a name="l01353"></a>01353         <span class="comment">/* Probably should not happen. */</span>
<a name="l01354"></a>01354         <a class="code" href="ccnd__msg_8c.html#ab366c8b24b40d405717b70124e6049be" title="Produce ccnd debug output.">ccnd_msg</a>(ccnd, <span class="stringliteral">&quot;ccnd_internal_client.c:%d Huh?&quot;</span>, __LINE__);
<a name="l01355"></a>01355         <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a>);
<a name="l01356"></a>01356     }
<a name="l01357"></a>01357     name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l01358"></a>01358     <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;ccnx:/ccnx&quot;</span>);
<a name="l01359"></a>01359     <a class="code" href="ccn_8h.html#a3f4f614f38ae77dccb4099e982c646f8" title="Add a Component to a Name.">ccn_name_append</a>(name, ccnd-&gt;<a class="code" href="structccnd__handle.html#a935a4fbf6e79b677d425d49661326e7e" title="sha256 digest of our public key">ccnd_id</a>, 32);
<a name="l01360"></a>01360     <a class="code" href="ccn_8h.html#aec5620dc4689a663ea7181cdebeda4d0" title="Add a Component that is a NUL-terminated string.">ccn_name_append_str</a>(name, <a class="code" href="ccnd__internal__client_8c.html#af19907a1c8ea7104bf766924bf233b9c">CCND_NOTICE_NAME</a>);
<a name="l01361"></a>01361     ccnd-&gt;<a class="code" href="structccnd__handle.html#ad4ea25e65cc040d7db4bfabc6d437efa" title="for notices of status changes">notice</a> = <a class="code" href="seqwriter_8h.html#a5813d07336301f112e452c38ae3dab35" title="Create a seqwriter for writing data to a versioned, segmented stream.">ccn_seqw_create</a>(h, name);
<a name="l01362"></a>01362     ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a> = <a class="code" href="indexbuf_8h.html#a00ef00b3c7cbd2122bcdad019bd285c6" title="Create a new indexbuf.">ccn_indexbuf_create</a>();
<a name="l01363"></a>01363     <span class="keywordflow">for</span> (i = 0; i &lt; ccnd-&gt;<a class="code" href="structccnd__handle.html#a2e868352005111e78ca9c83775aef754" title="current number of face slots">face_limit</a>; i++) {
<a name="l01364"></a>01364         face = ccnd-&gt;<a class="code" href="structccnd__handle.html#a9a1b3a7bbb5bc437ca828b28833f6f5f" title="array with face_limit elements">faces_by_faceid</a>[i];
<a name="l01365"></a>01365         <span class="keywordflow">if</span> (face != NULL)
<a name="l01366"></a>01366             <a class="code" href="indexbuf_8h.html#ac9d75b010bd9231b88c0c812d8d32c07">ccn_indexbuf_set_insert</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a>, face-&gt;<a class="code" href="structface.html#ad41672dc1c4db377303433b210f602f5" title="internal face id">faceid</a>);
<a name="l01367"></a>01367     }
<a name="l01368"></a>01368     <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a>-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a> &gt; 0)
<a name="l01369"></a>01369         <a class="code" href="ccnd__internal__client_8c.html#a9a8312e047d60e5e17dbe0f248ada546" title="Called by ccnd when a face undergoes a substantive status change that should be reported...">ccnd_face_status_change</a>(ccnd, ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a>-&gt;<a class="code" href="structccn__indexbuf.html#a92dbe917a112c3680bdf0230eb8a4692">buf</a>[0]);
<a name="l01370"></a>01370     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l01371"></a>01371 }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373 <span class="keywordtype">int</span>
<a name="l01374"></a><a class="code" href="ccnd__private_8h.html#aa71343e1d1f356515f0ac8c4a3a0985b">01374</a> <a class="code" href="ccnd__internal__client_8c.html#adb2e19eded1d4adc0221262d2fa5f894">ccnd_internal_client_start</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd)
<a name="l01375"></a>01375 {
<a name="l01376"></a>01376     <span class="keyword">struct </span>ccn *h;
<a name="l01377"></a>01377     <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a> != NULL)
<a name="l01378"></a>01378         <span class="keywordflow">return</span>(-1);
<a name="l01379"></a>01379     <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#a6721551353380a3ffc764072a9d0370c" title="special face for internal client">face0</a> == NULL)
<a name="l01380"></a>01380         abort();
<a name="l01381"></a>01381     ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a> = h = <a class="code" href="ccn_8h.html#aabd4b8732f28cfec43435b455a6eec7e" title="Create a client handle.">ccn_create</a>();
<a name="l01382"></a>01382     <span class="keywordflow">if</span> (<a class="code" href="ccnd__internal__client_8c.html#a951cf92331308d6ba8b12ba1139de139">ccnd_init_internal_keystore</a>(ccnd) &lt; 0) {
<a name="l01383"></a>01383         <a class="code" href="ccn_8h.html#adac19e5f8dd6cf3ecd73b85f77f161ae">ccn_destroy</a>(&amp;ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>);
<a name="l01384"></a>01384         <span class="keywordflow">return</span>(-1);
<a name="l01385"></a>01385     }
<a name="l01386"></a>01386 <span class="preprocessor">#if (CCND_PING+0)</span>
<a name="l01387"></a>01387 <span class="preprocessor"></span>    <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/ccnx/ping&quot;</span>,
<a name="l01388"></a>01388                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#a01aaa9cdf37bfba6b05e4465abe182c6">OP_PING</a>);
<a name="l01389"></a>01389     <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/ccnx/&quot;</span> <a class="code" href="ccnd__internal__client_8c.html#a82f0ee57c1a9bbc80af1c7c482d460c2">CCND_ID_TEMPL</a> <span class="stringliteral">&quot;/ping&quot;</span>,
<a name="l01390"></a>01390                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#a01aaa9cdf37bfba6b05e4465abe182c6">OP_PING</a>);
<a name="l01391"></a>01391 <span class="preprocessor">#endif</span>
<a name="l01392"></a>01392 <span class="preprocessor"></span>    <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/ccnx/&quot;</span> <a class="code" href="ccnd__internal__client_8c.html#a82f0ee57c1a9bbc80af1c7c482d460c2">CCND_ID_TEMPL</a> <span class="stringliteral">&quot;/newface&quot;</span>,
<a name="l01393"></a>01393                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#af61c9112fc18285a11dcdc19bb2eb5d2">OP_NEWFACE</a> + <a class="code" href="ccnd__internal__client_8c.html#a54fdd3bbf59345b3496d6b1628c9e30d">MUST_VERIFY1</a>);
<a name="l01394"></a>01394     <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/ccnx/&quot;</span> <a class="code" href="ccnd__internal__client_8c.html#a82f0ee57c1a9bbc80af1c7c482d460c2">CCND_ID_TEMPL</a> <span class="stringliteral">&quot;/destroyface&quot;</span>,
<a name="l01395"></a>01395                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#a7dd9285eeab9793dfd5033cf7353aa38">OP_DESTROYFACE</a> + <a class="code" href="ccnd__internal__client_8c.html#a54fdd3bbf59345b3496d6b1628c9e30d">MUST_VERIFY1</a>);
<a name="l01396"></a>01396     <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/ccnx/&quot;</span> <a class="code" href="ccnd__internal__client_8c.html#a82f0ee57c1a9bbc80af1c7c482d460c2">CCND_ID_TEMPL</a> <span class="stringliteral">&quot;/prefixreg&quot;</span>,
<a name="l01397"></a>01397                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#a86a8ce41e90e0acf5186b6846005163a">OP_PREFIXREG</a> + <a class="code" href="ccnd__internal__client_8c.html#a54fdd3bbf59345b3496d6b1628c9e30d">MUST_VERIFY1</a>);
<a name="l01398"></a>01398     <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/ccnx/&quot;</span> <a class="code" href="ccnd__internal__client_8c.html#a82f0ee57c1a9bbc80af1c7c482d460c2">CCND_ID_TEMPL</a> <span class="stringliteral">&quot;/selfreg&quot;</span>,
<a name="l01399"></a>01399                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#a7403c633c199ae5fdb285d51c445a466">OP_SELFREG</a> + <a class="code" href="ccnd__internal__client_8c.html#a54fdd3bbf59345b3496d6b1628c9e30d">MUST_VERIFY1</a>);
<a name="l01400"></a>01400     <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/ccnx/&quot;</span> <a class="code" href="ccnd__internal__client_8c.html#a82f0ee57c1a9bbc80af1c7c482d460c2">CCND_ID_TEMPL</a> <span class="stringliteral">&quot;/unreg&quot;</span>,
<a name="l01401"></a>01401                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#a00eb5f887f0faa76fae2ab76fa23bf4b">OP_UNREG</a> + <a class="code" href="ccnd__internal__client_8c.html#a54fdd3bbf59345b3496d6b1628c9e30d">MUST_VERIFY1</a>);
<a name="l01402"></a>01402     <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/ccnx/&quot;</span> <a class="code" href="ccnd__internal__client_8c.html#a82f0ee57c1a9bbc80af1c7c482d460c2">CCND_ID_TEMPL</a> <span class="stringliteral">&quot;/&quot;</span> <a class="code" href="ccnd__internal__client_8c.html#af19907a1c8ea7104bf766924bf233b9c">CCND_NOTICE_NAME</a>,
<a name="l01403"></a>01403                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#a5d793d91c901b7b88f493fa05248b573">OP_NOTICE</a>);
<a name="l01404"></a>01404     <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/%C1.M.S.localhost/%C1.M.SRV/ccnd&quot;</span>,
<a name="l01405"></a>01405                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#a87c25a5cbf8056c45500ea18f8cc6954">OP_SERVICE</a>);
<a name="l01406"></a>01406     <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/%C1.M.S.neighborhood&quot;</span>,
<a name="l01407"></a>01407                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#a87c25a5cbf8056c45500ea18f8cc6954">OP_SERVICE</a>);
<a name="l01408"></a>01408     <a class="code" href="ccnd__internal__client_8c.html#acd6c6a568652f2632a154eda85a7bc80">ccnd_uri_listen</a>(ccnd, <span class="stringliteral">&quot;ccnx:/%C1.M.FACE&quot;</span>,
<a name="l01409"></a>01409                     &amp;<a class="code" href="ccnd__internal__client_8c.html#ac34faaf88be420e85d486227c72f8533" title="Common interest handler for ccnd_internal_client.">ccnd_answer_req</a>, <a class="code" href="ccnd__internal__client_8c.html#acd6be347ddcb8be409557b4b0dcf5d94">OP_ADJACENCY</a>);
<a name="l01410"></a>01410     <a class="code" href="ccnd__internal__client_8c.html#abebd1396d6be057220f1cb2c62a59de6" title="Make a forwarding table entry for ccnx:/ccnx/CCNDID.">ccnd_reg_ccnx_ccndid</a>(ccnd);
<a name="l01411"></a>01411     <a class="code" href="ccnd_8c.html#a6a4a51f315cdeac27bdee3546f9d88f0" title="Register a prefix, expressed in the form of a URI.">ccnd_reg_uri</a>(ccnd, <span class="stringliteral">&quot;ccnx:/%C1.M.S.localhost&quot;</span>,
<a name="l01412"></a>01412                  0, <span class="comment">/* special faceid for internal client */</span>
<a name="l01413"></a>01413                  (<a class="code" href="reg__mgmt_8h.html#a38f4b34f7297b60fd82b57a6ce62d44f">CCN_FORW_CHILD_INHERIT</a> |
<a name="l01414"></a>01414                   <a class="code" href="reg__mgmt_8h.html#ae0ad3c46c8762dc3117420b77af96249" title="Refer to doc/technical/Registration.txt for the meaning of these flags.">CCN_FORW_ACTIVE</a>        |
<a name="l01415"></a>01415                   <a class="code" href="reg__mgmt_8h.html#a395064152732eb5145796693a20c34e6">CCN_FORW_LOCAL</a>         ),
<a name="l01416"></a>01416                  0x7FFFFFFF);
<a name="l01417"></a>01417     ccnd-&gt;<a class="code" href="structccnd__handle.html#a858f9215865200c123eca8c3a1828b6b">internal_client_refresh</a> \
<a name="l01418"></a>01418     = <a class="code" href="schedule_8h.html#a1b46f1ba6b54371f41a5c160cd1604ba">ccn_schedule_event</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a>, 50000,
<a name="l01419"></a>01419                          <a class="code" href="ccnd__internal__client_8c.html#a88ed95941a92a0e98de872c855de44c0">ccnd_internal_client_refresh</a>,
<a name="l01420"></a>01420                          NULL, <a class="code" href="ccn_8h.html#a33cae88a5004e98afb9d8c4d8ea79ad4">CCN_INTEREST_LIFETIME_MICROSEC</a>);
<a name="l01421"></a>01421     <span class="keywordflow">return</span>(0);
<a name="l01422"></a>01422 }
<a name="l01423"></a>01423 
<a name="l01424"></a>01424 <span class="keywordtype">void</span>
<a name="l01425"></a><a class="code" href="ccnd__private_8h.html#a78921ffb42650eac02edbaa8ef409e65">01425</a> <a class="code" href="ccnd__internal__client_8c.html#aca545bf1aa5a6d1aab5f447521ca0654">ccnd_internal_client_stop</a>(<span class="keyword">struct</span> <a class="code" href="structccnd__handle.html" title="We pass this handle almost everywhere within ccnd.">ccnd_handle</a> *ccnd)
<a name="l01426"></a>01426 {
<a name="l01427"></a>01427     ccnd-&gt;<a class="code" href="structccnd__handle.html#ad4ea25e65cc040d7db4bfabc6d437efa" title="for notices of status changes">notice</a> = NULL; <span class="comment">/* ccn_destroy will free */</span>
<a name="l01428"></a>01428     <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#a4af1b200fef141e2a3c90fae6f0e49ba">notice_push</a> != NULL)
<a name="l01429"></a>01429         <a class="code" href="schedule_8h.html#a0b636a012b97cc600634684736018fe7" title="Cancel a scheduled event.">ccn_schedule_cancel</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a>, ccnd-&gt;<a class="code" href="structccnd__handle.html#a4af1b200fef141e2a3c90fae6f0e49ba">notice_push</a>);
<a name="l01430"></a>01430     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;ccnd-&gt;<a class="code" href="structccnd__handle.html#a4896feace358bae444c064f001e51e94" title="faceids w/ recent status changes">chface</a>);
<a name="l01431"></a>01431     <a class="code" href="ccn_8h.html#adac19e5f8dd6cf3ecd73b85f77f161ae">ccn_destroy</a>(&amp;ccnd-&gt;<a class="code" href="structccnd__handle.html#a01ae729045dce23ebebf65bb06479b00" title="internal client">internal_client</a>);
<a name="l01432"></a>01432     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;ccnd-&gt;<a class="code" href="structccnd__handle.html#a2d44d3dadcbc86b822fb9bdcc20826ca" title="for local service discovery">service_ccnb</a>);
<a name="l01433"></a>01433     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;ccnd-&gt;<a class="code" href="structccnd__handle.html#abd6d813e2701a10266848476ec0f920d" title="for neighbor service discovery">neighbor_ccnb</a>);
<a name="l01434"></a>01434     <span class="keywordflow">if</span> (ccnd-&gt;<a class="code" href="structccnd__handle.html#a858f9215865200c123eca8c3a1828b6b">internal_client_refresh</a> != NULL)
<a name="l01435"></a>01435         <a class="code" href="schedule_8h.html#a0b636a012b97cc600634684736018fe7" title="Cancel a scheduled event.">ccn_schedule_cancel</a>(ccnd-&gt;<a class="code" href="structccnd__handle.html#ac638d1edc7e99be80a105b3fd5228bf7" title="our schedule">sched</a>, ccnd-&gt;<a class="code" href="structccnd__handle.html#a858f9215865200c123eca8c3a1828b6b">internal_client_refresh</a>);
<a name="l01436"></a>01436 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Sat Dec 8 09:41:49 2012 for Content-Centric Networking in C by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
